<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçΩÔ∏è Cloud Wochenplaner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header mit Cloud-Status */
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .cloud-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #e8f5e9;
            border-radius: 20px;
            font-size: 14px;
            color: #2e7d32;
        }

        .cloud-status.offline {
            background: #ffebee;
            color: #c62828;
        }

        .cloud-status.syncing {
            background: #fff3e0;
            color: #f57c00;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Hauptsteuerung */
        .main-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(118,75,162,0.3);
        }

        .btn-secondary {
            background: white;
            color: #764ba2;
            border: 2px solid #764ba2;
        }

        /* Wochen√ºbersicht */
        .week-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .day-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .day-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #764ba2;
            transition: all 0.3s;
            position: relative;
        }

        .day-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .day-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #764ba2;
        }

        .meal-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .meal-variations {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .variation-chip {
            padding: 3px 8px;
            background: #e3f2fd;
            border-radius: 12px;
            font-size: 12px;
            color: #1976d2;
            cursor: pointer;
            transition: all 0.2s;
        }

        .variation-chip:hover {
            background: #1976d2;
            color: white;
        }

        .variation-chip.active {
            background: #764ba2;
            color: white;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #764ba2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Setup Modal */
        .setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .setup-modal.active {
            display: flex;
        }

        .setup-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .setup-content h2 {
            color: #764ba2;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #764ba2;
        }

        /* Shopping List */
        .shopping-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .shopping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .shopping-category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .shopping-category h3 {
            color: #764ba2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .shopping-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .shopping-item:last-child {
            border-bottom: none;
        }

        .shopping-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 20px;
            background: #323232;
            color: white;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s;
            z-index: 10000;
        }

        .toast.show {
            display: block;
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .cloud-status {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 15px;
            }
            
            .main-controls {
                grid-template-columns: 1fr;
            }
            
            .shopping-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Synchronisiere mit Cloud...</p>
    </div>

    <!-- Setup Modal -->
    <div class="setup-modal" id="setupModal">
        <div class="setup-content">
            <h2>üîê Cloud-Verbindung einrichten</h2>
            <div class="form-group">
                <label>GitHub Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                <small style="color: #666; display: block; margin-top: 5px;">
                    Token erstellen: GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens
                </small>
            </div>
            <div class="form-group">
                <label>Gist ID (optional - f√ºr bestehenden Plan):</label>
                <input type="text" id="existingGistId" placeholder="Leer lassen f√ºr neuen Plan">
            </div>
            <div class="form-group">
                <label>Anzahl Erwachsene:</label>
                <input type="number" id="adultsCount" value="2" min="1" max="6">
            </div>
            <div class="form-group">
                <label>Anzahl Kinder:</label>
                <input type="number" id="childrenCount" value="2" min="0" max="6">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="connectToCloud()">
                ‚òÅÔ∏è Mit Cloud verbinden
            </button>
        </div>
    </div>

    <!-- Cloud Status Indicator -->
    <div class="cloud-status" id="cloudStatus">
        <div class="pulse"></div>
        <span id="cloudStatusText">Verbinde...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üçΩÔ∏è Intelligenter Wochenplaner</h1>
            <p>Cloud-basierte Essensplanung mit KI-Optimierung</p>
            <p style="margin-top: 10px; color: #666;">
                <span id="weekDate">Woche wird geladen...</span>
            </p>
        </div>

        <!-- Hauptsteuerung -->
        <div class="main-controls">
            <button class="btn btn-primary" onclick="generateSmartPlan()">
                üé≤ Neuer intelligenter Plan
            </button>
            <button class="btn btn-secondary" onclick="optimizeCurrentPlan()">
                üîÑ Plan optimieren
            </button>
            <button class="btn btn-secondary" onclick="showShoppingList()">
                üõí Einkaufsliste
            </button>
            <button class="btn btn-secondary" onclick="showSettings()">
                ‚öôÔ∏è Einstellungen
            </button>
        </div>

        <!-- Wochen√ºbersicht -->
        <div class="week-container">
            <h2>üìÖ Wochen√ºbersicht</h2>
            <div class="day-grid" id="weekGrid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>

        <!-- Einkaufsliste -->
        <div class="shopping-container" id="shoppingContainer" style="display: none;">
            <h2>üõí Einkaufsliste</h2>
            <button class="btn btn-secondary" onclick="hideShoppingList()" style="margin-bottom: 20px;">
                ‚Üê Zur√ºck zur √úbersicht
            </button>
            <div class="shopping-grid" id="shoppingGrid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Globale Cloud-Sync Konfiguration
        const CloudSync = {
            token: null,
            gistId: null,
            syncInterval: null,
            lastSync: null,
            isOnline: true,
            autoSaveTimeout: null
        };

        // Globale App-Daten (NUR im Speicher, nie lokal!)
        let AppData = {
            weekPlan: [],
            recipes: null,
            preferences: {
                adults: 2,
                children: 2,
                weeksSincePizza: 0,
                filters: {}
            },
            currentWeekStart: null,
            shoppingList: {}
        };

        // Intelligente Planungs-Engine
        const SmartPlanner = {
            // Erstelle einen intelligenten Wochenplan
            createPlan: function(recipes, preferences) {
                const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
                const plan = [];
                const usedRecipes = new Set();
                const usedMainIngredients = new Map();
                
                days.forEach((day, index) => {
                    // W√§hle intelligentes Rezept basierend auf:
                    // - Keine Wiederholungen
                    // - Abwechslung bei Hauptzutaten
                    // - Saisonalit√§t
                    // - Wochenend-Specials
                    
                    const isWeekend = index >= 5;
                    const needsWorkFriendly = index < 4;
                    
                    // Finde passendes Rezept
                    let recipe = this.selectSmartRecipe(
                        recipes,
                        usedRecipes,
                        usedMainIngredients,
                        isWeekend,
                        needsWorkFriendly
                    );
                    
                    // F√ºge Variationen hinzu
                    if (recipe && recipe.baseIngredients) {
                        recipe = this.addVariations(recipe);
                    }
                    
                    plan.push({
                        day: day,
                        date: this.getDateForDay(index),
                        dinner: recipe,
                        variations: recipe.variations || []
                    });
                    
                    if (recipe) {
                        usedRecipes.add(recipe.id);
                        this.trackIngredients(recipe, usedMainIngredients, index);
                    }
                });
                
                return plan;
            },
            
            selectSmartRecipe: function(recipes, usedRecipes, usedMainIngredients, isWeekend, needsWorkFriendly) {
                // Filtere verf√ºgbare Rezepte
                const available = [];
                
                ['meat', 'vegetarian'].forEach(category => {
                    if (recipes.categories[category]) {
                        recipes.categories[category].recipes.forEach(recipe => {
                            if (!usedRecipes.has(recipe.id)) {
                                // Pr√ºfe Arbeitsfreundlichkeit
                                if (needsWorkFriendly && recipe.workFriendly === false) {
                                    return;
                                }
                                
                                // Pr√ºfe Wiederholungen von Hauptzutaten
                                let tooSimilar = false;
                                for (let [ingredient, lastDay] of usedMainIngredients) {
                                    if (recipe.baseIngredients && recipe.baseIngredients[ingredient]) {
                                        if (lastDay >= 0 && lastDay < 3) { // Zu nah
                                            tooSimilar = true;
                                            break;
                                        }
                                    }
                                }
                                
                                if (!tooSimilar) {
                                    available.push(recipe);
                                }
                            }
                        });
                    }
                });
                
                // W√§hle zuf√§llig aus verf√ºgbaren
                if (available.length > 0) {
                    return available[Math.floor(Math.random() * available.length)];
                }
                
                // Fallback: Irgendein Rezept
                const allRecipes = [];
                Object.values(recipes.categories).forEach(cat => {
                    allRecipes.push(...cat.recipes);
                });
                return allRecipes[Math.floor(Math.random() * allRecipes.length)];
            },
            
            addVariations: function(recipe) {
                const variations = [];
                
                // Pasta-Variationen
                if (recipe.baseIngredients.pasta) {
                    const pastaType = recipe.baseIngredients.pasta;
                    if (pastaType.variations) {
                        variations.push({
                            type: 'pasta',
                            options: pastaType.variations,
                            selected: pastaType.variations[0]
                        });
                    }
                }
                
                // Andere Variationen
                Object.entries(recipe.baseIngredients).forEach(([key, value]) => {
                    if (value.variations && key !== 'pasta') {
                        variations.push({
                            type: key,
                            options: value.variations,
                            selected: value.variations[0]
                        });
                    }
                });
                
                recipe.variations = variations;
                return recipe;
            },
            
            trackIngredients: function(recipe, usedMainIngredients, dayIndex) {
                if (!recipe.baseIngredients) return;
                
                // Tracke Hauptzutaten
                ['pasta', 'fleisch', 'k√§se'].forEach(ingredient => {
                    if (recipe.baseIngredients[ingredient]) {
                        usedMainIngredients.set(ingredient, dayIndex);
                    }
                });
            },
            
            getDateForDay: function(dayIndex) {
                const today = new Date();
                const currentDay = today.getDay();
                const daysUntilMonday = currentDay === 0 ? 1 : 8 - currentDay;
                const monday = new Date(today);
                monday.setDate(today.getDate() + daysUntilMonday - 7);
                
                const targetDate = new Date(monday);
                targetDate.setDate(monday.getDate() + dayIndex);
                
                return targetDate.toLocaleDateString('de-CH', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });
            }
        };

        // Initialisierung
        window.addEventListener('DOMContentLoaded', async function() {
            // Pr√ºfe ob Token vorhanden
            const savedToken = sessionStorage.getItem('githubToken');
            const savedGistId = sessionStorage.getItem('currentGistId');
            
            if (savedToken && savedGistId) {
                CloudSync.token = savedToken;
                CloudSync.gistId = savedGistId;
                await initializeApp();
            } else {
                showSetupModal();
            }
        });

        // Setup Modal anzeigen
        function showSetupModal() {
            document.getElementById('setupModal').classList.add('active');
        }

        // Mit Cloud verbinden
        async function connectToCloud() {
            const token = document.getElementById('githubToken').value;
            const gistId = document.getElementById('existingGistId').value;
            const adults = document.getElementById('adultsCount').value;
            const children = document.getElementById('childrenCount').value;
            
            if (!token) {
                showToast('Bitte GitHub Token eingeben!', 'error');
                return;
            }
            
            showLoading('Verbinde mit Cloud...');
            
            CloudSync.token = token;
            sessionStorage.setItem('githubToken', token);
            
            AppData.preferences.adults = parseInt(adults);
            AppData.preferences.children = parseInt(children);
            
            try {
                if (gistId) {
                    // Lade bestehenden Plan
                    CloudSync.gistId = gistId;
                    sessionStorage.setItem('currentGistId', gistId);
                    await loadFromCloud();
                } else {
                    // Erstelle neuen Plan
                    await createNewCloudPlan();
                }
                
                document.getElementById('setupModal').classList.remove('active');
                await initializeApp();
                
            } catch (error) {
                showToast('Fehler: ' + error.message, 'error');
                hideLoading();
            }
        }

        // App initialisieren
        async function initializeApp() {
            showLoading('Lade Rezepte und synchronisiere...');
            
            try {
                // Lade Rezepte (diese k√∂nnten auch aus der Cloud kommen)
                await loadRecipes();
                
                // Lade aktuellen Plan aus Cloud
                if (CloudSync.gistId) {
                    await loadFromCloud();
                } else {
                    // Erstelle neuen Plan
                    await generateSmartPlan();
                }
                
                // Starte Auto-Sync
                startAutoSync();
                
                // Update UI
                updateCloudStatus('online');
                displayWeekPlan();
                hideLoading();
                
            } catch (error) {
                console.error('Initialisierungsfehler:', error);
                showToast('Fehler beim Laden: ' + error.message, 'error');
                hideLoading();
            }
        }

        // Rezepte laden
        async function loadRecipes() {
            try {
                // Lade die externe recipes.json Datei
                const response = await fetch('recipes.json');
                if (!response.ok) {
                    throw new Error('Fehler beim Laden der Rezepte');
                }
                AppData.recipes = await response.json();
                console.log(`‚úì ${countTotalRecipes()} Rezepte geladen`);
            } catch (error) {
                console.error('Fehler beim Laden der recipes.json:', error);
                showToast('Fehler beim Laden der Rezepte!', 'error');
                // Fallback auf leere Struktur
                AppData.recipes = {
                    categories: {
                        meat: { recipes: [] },
                        vegetarian: { recipes: [] },
                        kids: { recipes: [] }
                    }
                };
            }
        }
        
        // Z√§hle alle Rezepte
        function countTotalRecipes() {
            let count = 0;
            Object.values(AppData.recipes.categories).forEach(cat => {
                count += cat.recipes.length;
            });
            return count;
        }

        // Neuen Cloud-Plan erstellen
        async function createNewCloudPlan() {
            const gistData = {
                description: `Wochenplan ${new Date().toLocaleDateString('de-CH')}`,
                public: false,
                files: {
                    'wochenplan.json': {
                        content: JSON.stringify({
                            version: '2.0',
                            weekPlan: [],
                            preferences: AppData.preferences,
                            shoppingList: {},
                            lastUpdate: new Date().toISOString()
                        }, null, 2)
                    }
                }
            };
            
            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${CloudSync.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gistData)
            });
            
            if (!response.ok) {
                throw new Error('Fehler beim Erstellen des Cloud-Plans');
            }
            
            const result = await response.json();
            CloudSync.gistId = result.id;
            sessionStorage.setItem('currentGistId', result.id);
        }

        // Aus Cloud laden
        async function loadFromCloud() {
            if (!CloudSync.gistId) return;
            
            const response = await fetch(`https://api.github.com/gists/${CloudSync.gistId}`, {
                headers: {
                    'Authorization': `token ${CloudSync.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Fehler beim Laden aus der Cloud');
            }
            
            const gist = await response.json();
            const content = gist.files['wochenplan.json'].content;
            const data = JSON.parse(content);
            
            AppData.weekPlan = data.weekPlan || [];
            AppData.preferences = {...AppData.preferences, ...data.preferences};
            AppData.shoppingList = data.shoppingList || {};
            CloudSync.lastSync = new Date();
        }

        // In Cloud speichern
        async function saveToCloud() {
            if (!CloudSync.gistId) return;
            
            const data = {
                version: '2.0',
                weekPlan: AppData.weekPlan,
                preferences: AppData.preferences,
                shoppingList: AppData.shoppingList,
                lastUpdate: new Date().toISOString()
            };
            
            const response = await fetch(`https://api.github.com/gists/${CloudSync.gistId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${CloudSync.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'wochenplan.json': {
                            content: JSON.stringify(data, null, 2)
                        }
                    }
                })
            });
            
            if (response.ok) {
                CloudSync.lastSync = new Date();
                updateCloudStatus('online');
                showToast('‚úì Gespeichert', 'success');
            }
        }

        // Auto-Sync starten
        function startAutoSync() {
            // Speichere bei jeder √Ñnderung
            CloudSync.syncInterval = setInterval(async () => {
                if (CloudSync.isOnline) {
                    await saveToCloud();
                }
            }, 30000); // Alle 30 Sekunden
        }

        // Auto-Save bei √Ñnderungen
        function triggerAutoSave() {
            clearTimeout(CloudSync.autoSaveTimeout);
            CloudSync.autoSaveTimeout = setTimeout(() => {
                saveToCloud();
            }, 2000); // 2 Sekunden nach letzter √Ñnderung
        }

        // Intelligenten Plan generieren
        async function generateSmartPlan() {
            if (!AppData.recipes) {
                await loadRecipes();
            }
            
            showLoading('Erstelle intelligenten Wochenplan...');
            
            // Erstelle Plan mit KI-Engine
            AppData.weekPlan = SmartPlanner.createPlan(AppData.recipes, AppData.preferences);
            
            // Erstelle Einkaufsliste
            generateShoppingList();
            
            // Speichere in Cloud
            await saveToCloud();
            
            // Update UI
            displayWeekPlan();
            hideLoading();
            
            showToast('‚úì Neuer Plan erstellt', 'success');
        }

        // Plan optimieren
        function optimizeCurrentPlan() {
            showToast('üîÑ Optimiere Plan...', 'info');
            
            // Hier k√∂nnte eine echte Optimierung stattfinden
            // z.B. Preisoptimierung, N√§hrstoffbalance, etc.
            
            setTimeout(() => {
                showToast('‚úì Plan optimiert', 'success');
                triggerAutoSave();
            }, 1000);
        }

        // Wochenplan anzeigen
        function displayWeekPlan() {
            const grid = document.getElementById('weekGrid');
            grid.innerHTML = '';
            
            AppData.weekPlan.forEach((day, index) => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                
                let variationsHtml = '';
                if (day.variations && day.variations.length > 0) {
                    variationsHtml = day.variations.map(v => `
                        <div class="meal-variations">
                            <small style="color: #666;">Variante:</small>
                            ${v.options.map(opt => `
                                <span class="variation-chip ${opt === v.selected ? 'active' : ''}" 
                                      onclick="selectVariation(${index}, '${v.type}', '${opt}')">
                                    ${opt}
                                </span>
                            `).join('')}
                        </div>
                    `).join('');
                }
                
                dayCard.innerHTML = `
                    <div class="day-header">
                        <span class="day-name">${day.day} <small style="color: #999;">${day.date}</small></span>
                        <span style="color: #4caf50; font-weight: bold;">
                            ${day.dinner ? day.dinner.price + ' CHF' : ''}
                        </span>
                    </div>
                    <div class="meal-name">
                        ${day.dinner ? day.dinner.name : 'Kein Rezept'}
                    </div>
                    ${variationsHtml}
                    <button class="btn btn-secondary" style="margin-top: 10px; padding: 8px;" 
                            onclick="changeMeal(${index})">
                        üîÑ √Ñndern
                    </button>
                `;
                
                grid.appendChild(dayCard);
            });
            
            // Update Wochendatum
            const weekStart = new Date();
            const weekEnd = new Date();
            weekEnd.setDate(weekStart.getDate() + 6);
            
            document.getElementById('weekDate').textContent = 
                `${weekStart.toLocaleDateString('de-CH')} - ${weekEnd.toLocaleDateString('de-CH')}`;
        }

        // Variation ausw√§hlen
        function selectVariation(dayIndex, type, option) {
            const day = AppData.weekPlan[dayIndex];
            if (day.variations) {
                const variation = day.variations.find(v => v.type === type);
                if (variation) {
                    variation.selected = option;
                    displayWeekPlan();
                    triggerAutoSave();
                }
            }
        }

        // Mahlzeit √§ndern
        function changeMeal(dayIndex) {
            // W√§hle neues zuf√§lliges Rezept
            const allRecipes = [];
            Object.values(AppData.recipes.categories).forEach(cat => {
                allRecipes.push(...cat.recipes);
            });
            
            const newRecipe = allRecipes[Math.floor(Math.random() * allRecipes.length)];
            AppData.weekPlan[dayIndex].dinner = SmartPlanner.addVariations(newRecipe);
            
            displayWeekPlan();
            generateShoppingList();
            triggerAutoSave();
            
            showToast('‚úì Rezept ge√§ndert', 'success');
        }

        // Einkaufsliste generieren
        function generateShoppingList() {
            AppData.shoppingList = {};
            
            AppData.weekPlan.forEach(day => {
                if (day.dinner && day.dinner.baseIngredients) {
                    Object.entries(day.dinner.baseIngredients).forEach(([key, value]) => {
                        const ingredient = day.variations && day.variations.find(v => v.type === key)
                            ? day.variations.find(v => v.type === key).selected
                            : key;
                        
                        if (!AppData.shoppingList[ingredient]) {
                            AppData.shoppingList[ingredient] = {
                                amount: 0,
                                unit: value.unit || ''
                            };
                        }
                        
                        const portions = AppData.preferences.adults + (AppData.preferences.children * 0.5);
                        AppData.shoppingList[ingredient].amount += value.amount * portions;
                    });
                }
            });
        }

        // Einkaufsliste anzeigen
        function showShoppingList() {
            generateShoppingList();
            
            document.querySelector('.week-container').style.display = 'none';
            document.getElementById('shoppingContainer').style.display = 'block';
            
            const grid = document.getElementById('shoppingGrid');
            grid.innerHTML = '';
            
            // Kategorisiere Zutaten
            const categories = {
                'Fleisch & Fisch': [],
                'Milchprodukte': [],
                'Gem√ºse & Obst': [],
                'Nudeln & Reis': [],
                'Sonstiges': []
            };
            
            Object.entries(AppData.shoppingList).forEach(([item, data]) => {
                const lower = item.toLowerCase();
                let category = 'Sonstiges';
                
                if (lower.includes('fleisch') || lower.includes('h√§hnchen') || 
                    lower.includes('rind') || lower.includes('schwein')) {
                    category = 'Fleisch & Fisch';
                } else if (lower.includes('k√§se') || lower.includes('milch') || 
                           lower.includes('sahne') || lower.includes('butter')) {
                    category = 'Milchprodukte';
                } else if (lower.includes('zwiebel') || lower.includes('paprika') || 
                           lower.includes('zucchini') || lower.includes('tomate')) {
                    category = 'Gem√ºse & Obst';
                } else if (lower.includes('pasta') || lower.includes('reis') || 
                           lower.includes('nudel') || lower.includes('sp√§tzle')) {
                    category = 'Nudeln & Reis';
                }
                
                categories[category].push({
                    name: item,
                    amount: Math.round(data.amount * 10) / 10,
                    unit: data.unit
                });
            });
            
            // Erstelle Kategorien
            Object.entries(categories).forEach(([category, items]) => {
                if (items.length === 0) return;
                
                const catDiv = document.createElement('div');
                catDiv.className = 'shopping-category';
                catDiv.innerHTML = `
                    <h3>${category === 'Fleisch & Fisch' ? 'ü•©' : 
                         category === 'Milchprodukte' ? 'üßÄ' :
                         category === 'Gem√ºse & Obst' ? 'ü•ï' :
                         category === 'Nudeln & Reis' ? 'üçù' : 'üì¶'} ${category}</h3>
                    ${items.map(item => `
                        <div class="shopping-item">
                            <input type="checkbox">
                            <span>${item.name}: ${item.amount} ${item.unit}</span>
                        </div>
                    `).join('')}
                `;
                grid.appendChild(catDiv);
            });
        }

        // Einkaufsliste ausblenden
        function hideShoppingList() {
            document.getElementById('shoppingContainer').style.display = 'none';
            document.querySelector('.week-container').style.display = 'block';
        }

        // Cloud Status Update
        function updateCloudStatus(status) {
            const statusEl = document.getElementById('cloudStatus');
            const statusText = document.getElementById('cloudStatusText');
            
            statusEl.className = 'cloud-status';
            
            switch(status) {
                case 'online':
                    statusText.textContent = 'Synchronisiert';
                    break;
                case 'syncing':
                    statusEl.classList.add('syncing');
                    statusText.textContent = 'Synchronisiere...';
                    break;
                case 'offline':
                    statusEl.classList.add('offline');
                    statusText.textContent = 'Offline';
                    break;
            }
        }

        // UI Helper Functions
        function showLoading(message) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.querySelector('p').textContent = message || 'Lade...';
            overlay.classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showSettings() {
            showToast('‚öôÔ∏è Einstellungen kommen bald...', 'info');
        }

        // Online/Offline Detection
        window.addEventListener('online', () => {
            CloudSync.isOnline = true;
            updateCloudStatus('online');
            saveToCloud();
        });

        window.addEventListener('offline', () => {
            CloudSync.isOnline = false;
            updateCloudStatus('offline');
        });

        // Cleanup beim Verlassen
        window.addEventListener('beforeunload', () => {
            if (CloudSync.syncInterval) {
                clearInterval(CloudSync.syncInterval);
            }
        });
    </script>
</body>
</html>
