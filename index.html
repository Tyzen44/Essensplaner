<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Familien-Wochenplaner | Mobile Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            font-size: 14px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .container {
            max-width: 100%;
            padding: 0;
        }

        /* Header kompakt */
        .header {
            background: white;
            padding: 12px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: #764ba2;
            font-size: 1.3em;
            margin-bottom: 3px;
        }

        .header p {
            color: #666;
            font-size: 0.75em;
            display: none; /* Auf Mobile ausblenden */
        }

        .cloud-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: #e8f5e9;
            border-radius: 12px;
            font-size: 0.7em;
            color: #2e7d32;
            margin-top: 5px;
        }

        .cloud-status.offline {
            background: #ffebee;
            color: #c62828;
        }

        .cloud-status.syncing {
            background: #fff3e0;
            color: #f57c00;
        }

        .pulse {
            width: 6px;
            height: 6px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Pizza Indikator kompakt */
        .pizza-indicator {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.75em;
            display: inline-block;
            margin-top: 5px;
        }

        /* Sync Info kompakter */
        .sync-info {
            background: #f0f8ff;
            padding: 8px 12px;
            margin: 8px;
            font-size: 0.7em;
            color: #555;
            border-radius: 8px;
        }

        /* Statistiken Box kompakter */
        .stats-box {
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats-box h3 {
            color: #2196F3;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .stats-box p {
            font-size: 0.75em;
            margin: 3px 0;
        }

        /* Hauptsteuerung - kompaktere Buttons */
        .main-controls {
            padding: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .btn {
            padding: 10px 8px;
            border: none;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #764ba2;
            border: 1.5px solid #764ba2;
        }

        /* Tabs - Horizontal scrollbar f√ºr Mobile */
        .tabs-container {
            background: white;
            margin: 8px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tabs {
            display: flex;
            gap: 5px;
            padding: 8px;
            min-width: max-content;
        }

        .tab {
            padding: 8px 16px;
            background: #f8f8f8;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.8em;
            white-space: nowrap;
            flex-shrink: 0;
            -webkit-appearance: none;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 8px;
            min-height: calc(100vh - 350px);
        }

        .tab-content.active {
            display: block;
        }

        /* Wochen√ºbersicht - kompaktere Karten */
        .day-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .day-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            border-left: 4px solid #764ba2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .day-card.pizza-day {
            background: linear-gradient(135deg, #fff5f5 0%, #ffeaa7 100%);
            border-left: 4px solid #ff6b6b;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }

        .day-name {
            font-size: 1em;
            font-weight: bold;
            color: #764ba2;
        }

        .day-name small {
            font-size: 0.75em;
            color: #999;
            margin-left: 5px;
        }

        .price-tag {
            background: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.75em;
        }

        .meal-section {
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.6);
            border-radius: 6px;
        }

        .meal-type {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .meal-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        .meal-details {
            color: #666;
            font-size: 0.7em;
        }

        .meal-variations {
            display: flex;
            gap: 4px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .variation-chip {
            padding: 2px 6px;
            background: #e3f2fd;
            border-radius: 10px;
            font-size: 0.65em;
            color: #1976d2;
            cursor: pointer;
        }

        .variation-chip.active {
            background: #764ba2;
            color: white;
        }

        .swap-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Budget Anzeige kompakt */
        .budget-display {
            font-size: 0.9em;
            color: #4CAF50;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Einkaufsliste */
        .shopping-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .shopping-category {
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .shopping-category h3 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .shopping-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.8em;
        }

        .shopping-item:last-child {
            border-bottom: none;
        }

        .shopping-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }

        /* Einstellungen */
        .settings-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-group {
            background: white;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .setting-group h3 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 0.8em;
        }

        .setting-group input[type="number"],
        .setting-group select,
        .setting-group input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 3px;
            font-size: 0.85em;
        }

        .filter-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            margin: 0;
            font-size: 0.75em;
        }

        .filter-group input[type="checkbox"] {
            margin-right: 5px;
            width: 16px;
            height: 16px;
        }

        /* Personen Einstellungen kompakt */
        .person-settings {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .person-item {
            display: grid;
            grid-template-columns: 1fr 0.5fr auto;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .person-item input[type="text"] {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .person-item input[type="number"] {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8em;
        }

        .person-item .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75em;
        }

        .add-person-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 8px;
            font-size: 0.8em;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 15px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #764ba2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Setup Modal */
        .setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .setup-modal.active {
            display: flex;
        }

        .setup-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
        }

        .setup-content h2 {
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 0.85em;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1.5px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        /* Toast kompakt */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            left: 20px;
            padding: 12px 15px;
            background: #323232;
            color: white;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s;
            z-index: 10000;
            font-size: 0.85em;
            text-align: center;
        }

        .toast.show {
            display: block;
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #f44336;
        }

        .toast.info {
            background: #2196F3;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Rezepte Ansicht kompakt */
        #recipesList > div {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #recipesList h3 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 1em;
        }

        #recipesList h4 {
            font-size: 0.85em;
            margin: 10px 0 5px 0;
        }

        #recipesList ul, #recipesList ol {
            font-size: 0.75em;
            padding-left: 20px;
        }

        #recipesList li {
            margin-bottom: 3px;
        }

        /* Optimierung f√ºr sehr kleine Bildschirme */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 1.1em;
            }
            
            .main-controls {
                grid-template-columns: 1fr;
            }
            
            .filter-group {
                grid-template-columns: 1fr;
            }
        }

        /* iOS spezifische Optimierungen */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-text-size-adjust: 100%;
            }
            
            input, select, textarea {
                font-size: 16px; /* Verhindert Zoom beim Fokus */
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p style="font-size: 0.85em;">Synchronisiere...</p>
    </div>

    <!-- Setup Modal -->
    <div class="setup-modal" id="setupModal">
        <div class="setup-content">
            <h2>Cloud-Verbindung</h2>
            <div class="form-group">
                <label>GitHub Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                <small style="color: #666; display: block; margin-top: 5px; font-size: 0.7em;">
                    GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Tokens
                </small>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="connectToCloud()">
                ‚òÅÔ∏è Verbinden
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Familien-Wochenplaner</h1>
            <div class="cloud-status" id="cloudStatus">
                <div class="pulse"></div>
                <span id="cloudStatusText">Verbinde...</span>
            </div>
            <div id="pizzaIndicator" style="display: none;">
                <span class="pizza-indicator">üçï Pizza-Wochenende!</span>
            </div>
        </div>

        <!-- Sync Info -->
        <div class="sync-info">
            <strong>Status:</strong> <span id="syncStatus">Init...</span> | 
            <strong>ID:</strong> <span id="currentGistId" style="font-family: monospace;">-</span> | 
            <strong>Sync:</strong> <span id="lastSyncTime">-</span>
        </div>

        <!-- Statistiken -->
        <div class="stats-box">
            <h3>Rezept-Datenbank</h3>
            <p><strong id="totalRecipes">0</strong> Rezepte | 
               <strong id="meatCount">0</strong> Fleisch | 
               <strong id="vegCount">0</strong> Veg | 
               <strong id="kidsCount">0</strong> Kinder</p>
            <p>Pizza in <strong id="pizzaCountdown">...</strong> Woche(n)</p>
        </div>

        <!-- Hauptsteuerung -->
        <div class="main-controls">
            <button class="btn btn-primary" onclick="generateSmartPlan()">
                üìÖ Neuer Plan
            </button>
            <button class="btn btn-primary" onclick="optimizeCurrentPlan()">
                ‚ö° Optimieren
            </button>
            <button class="btn btn-secondary" onclick="exportToPDF()">
                üìÑ PDF
            </button>
            <button class="btn btn-secondary" onclick="forceCloudSync()">
                ‚òÅÔ∏è Sync
            </button>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'overview')">Woche</button>
                <button class="tab" onclick="switchTab(event, 'shopping')">Einkauf</button>
                <button class="tab" onclick="switchTab(event, 'recipes')">Rezepte</button>
                <button class="tab" onclick="switchTab(event, 'settings')">Einstellungen</button>
            </div>
        </div>

        <!-- Tab: Wochen√ºbersicht -->
        <div id="overview" class="tab-content active">
            <div class="day-grid" id="weekGrid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
            <div class="budget-display">
                Woche: <span id="totalCost">0</span> CHF
            </div>
        </div>

        <!-- Tab: Einkaufsliste -->
        <div id="shopping" class="tab-content">
            <div class="shopping-grid" id="shoppingGrid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>

        <!-- Tab: Rezepte -->
        <div id="recipes" class="tab-content">
            <div id="recipesList">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>

        <!-- Tab: Einstellungen -->
        <div id="settings" class="tab-content">
            <div class="settings-grid">
                <div class="setting-group">
                    <h3>Familie & Portionen</h3>
                    <div id="personsList" class="person-settings">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                    <button class="add-person-btn" onclick="addPerson()">+ Person</button>
                </div>
                
                <div class="setting-group">
                    <h3>Budget</h3>
                    <label>
                        Tagesbudget (CHF):
                        <input type="number" id="dailyBudget" value="25" min="10" max="50" onchange="updatePreferences()">
                    </label>
                    <label>
                        Woche: <strong id="weeklyBudget">175 CHF</strong>
                    </label>
                </div>
                
                <div class="setting-group">
                    <h3>Ern√§hrung</h3>
                    <label>
                        Vegetarische Tage:
                        <input type="number" id="vegDays" value="3" min="0" max="7" onchange="updatePreferences()">
                    </label>
                    <label>
                        Pizza-Wochenende:
                        <select id="pizzaFrequency" onchange="updatePreferences()">
                            <option value="2">Alle 2 Wochen</option>
                            <option value="3" selected>2-3 Wochen</option>
                            <option value="4">3-4 Wochen</option>
                            <option value="0">Nie</option>
                        </select>
                    </label>
                </div>

                <div class="setting-group">
                    <h3>Fleisch-Filter</h3>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="noLamb" onchange="updatePreferences()"> Kein Lamm
                        </label>
                        <label>
                            <input type="checkbox" id="noPork" onchange="updatePreferences()"> Kein Schwein
                        </label>
                        <label>
                            <input type="checkbox" id="noBeef" onchange="updatePreferences()"> Kein Rind
                        </label>
                        <label>
                            <input type="checkbox" id="noDuck" onchange="updatePreferences()"> Keine Ente
                        </label>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>Weitere Filter</h3>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="noGorgonzola" onchange="updatePreferences()"> Kein Gorgonzola
                        </label>
                        <label>
                            <input type="checkbox" id="noFeta" onchange="updatePreferences()"> Kein Feta
                        </label>
                        <label>
                            <input type="checkbox" id="noFish" onchange="updatePreferences()"> Kein Fisch
                        </label>
                        <label>
                            <input type="checkbox" id="noMushrooms" onchange="updatePreferences()"> Keine Pilze
                        </label>
                        <label>
                            <input type="checkbox" id="noNuts" onchange="updatePreferences()"> Keine N√ºsse
                        </label>
                        <label>
                            <input type="checkbox" id="noSpicy" onchange="updatePreferences()"> Nicht scharf
                        </label>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>GitHub Token</h3>
                    <label>
                        Token:
                        <input type="password" id="settingsGithubToken" placeholder="ghp_xxxxxxxxxxxx" onchange="updateToken()">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Globale Cloud-Sync Konfiguration
        const CloudSync = {
            token: null,
            gistId: null,
            syncInterval: null,
            lastSync: null,
            isOnline: true,
            autoSaveTimeout: null,
            syncPollInterval: null,
            lastUpdateTime: null
        };

        // Globale App-Daten
        let AppData = {
            weekPlan: [],
            recipes: null,
            preferences: {
                persons: [
                    { name: 'Person 1', portions: 1.2 },
                    { name: 'Person 2', portions: 0.8 },
                    { name: 'Kind 1', portions: 0.5 },
                    { name: 'Kind 2', portions: 0.5 }
                ],
                weeksSincePizza: 0,
                vegDays: 3,
                dailyBudget: 25,
                pizzaFrequency: "3",
                filters: {
                    noLamb: false,
                    noPork: false,
                    noBeef: false,
                    noDuck: false,
                    noGorgonzola: false,
                    noFeta: false,
                    noFish: false,
                    noMushrooms: false,
                    noNuts: false,
                    noSpicy: false
                }
            },
            currentWeekStart: null,
            shoppingList: {},
            kidsLunchTueThu: null
        };

        // ========== NEUE OPTIMIERUNGS-ENGINE ==========
        const PlanOptimizer = {
            // Hauptoptimierungsfunktion
            optimize: function(currentPlan, recipes, preferences) {
                showLoading('Analysiere aktuellen Plan...');
                
                let optimizedPlan = [...currentPlan];
                let improvements = [];
                
                // 1. Preis-Optimierung
                const budgetResult = this.optimizeBudget(optimizedPlan, recipes, preferences);
                if (budgetResult.improved) {
                    optimizedPlan = budgetResult.plan;
                    improvements.push(`üí∞ ${budgetResult.savings.toFixed(2)} CHF gespart`);
                }
                
                // 2. Zutaten-Optimierung (gemeinsame Zutaten)
                const ingredientResult = this.optimizeIngredients(optimizedPlan, recipes);
                if (ingredientResult.improved) {
                    optimizedPlan = ingredientResult.plan;
                    improvements.push(`üõí Einkauf optimiert`);
                }
                
                // 3. Arbeitsfreundlichkeit
                const workResult = this.optimizeForWork(optimizedPlan, recipes);
                if (workResult.improved) {
                    optimizedPlan = workResult.plan;
                    improvements.push(`üíº Arbeitsgerichte verbessert`);
                }
                
                // 4. Abwechslung
                const varietyResult = this.optimizeVariety(optimizedPlan, recipes);
                if (varietyResult.improved) {
                    optimizedPlan = varietyResult.plan;
                    improvements.push(`üéØ Mehr Abwechslung`);
                }
                
                // 5. Vorbereitungszeit
                const timeResult = this.optimizePrepTime(optimizedPlan, recipes);
                if (timeResult.improved) {
                    optimizedPlan = timeResult.plan;
                    improvements.push(`‚è±Ô∏è Schnellere Gerichte werktags`);
                }
                
                return {
                    plan: optimizedPlan,
                    improvements: improvements,
                    optimized: improvements.length > 0
                };
            },
            
            // Budget-Optimierung
            optimizeBudget: function(plan, recipes, preferences) {
                let improved = false;
                let newPlan = [...plan];
                let totalSavings = 0;
                const dailyBudget = preferences.dailyBudget;
                
                plan.forEach((day, index) => {
                    if (!day.dinner || day.dinner.special === 'pizza-weekend') return;
                    
                    const portions = SmartPlanner.calculatePortionsForDay(index);
                    const currentCost = day.dinner.price * portions;
                    
                    if (currentCost > dailyBudget) {
                        const isVeg = day.dinner.category === 'Vegetarisch';
                        const availableRecipes = isVeg ? 
                            recipes.vegetarian : recipes.meat;
                        
                        const filtered = SmartPlanner.filterRecipes(availableRecipes)
                            .filter(r => r.price * portions <= dailyBudget)
                            .sort((a, b) => b.price - a.price); // Teuerste zuerst (aber unter Budget)
                        
                        if (filtered.length > 0) {
                            const newRecipe = filtered[0];
                            const savings = currentCost - (newRecipe.price * portions);
                            
                            newPlan[index].dinner = SmartPlanner.addVariations({...newRecipe});
                            newPlan[index].variations = newPlan[index].dinner.variations;
                            
                            totalSavings += savings;
                            improved = true;
                        }
                    }
                });
                
                return {
                    plan: newPlan,
                    improved: improved,
                    savings: totalSavings
                };
            },
            
            // Zutaten-Optimierung
            optimizeIngredients: function(plan, recipes) {
                let improved = false;
                let newPlan = [...plan];
                
                // Sammle h√§ufige Zutaten
                const ingredientCount = new Map();
                plan.forEach(day => {
                    if (day.dinner && day.dinner.baseIngredients) {
                        Object.keys(day.dinner.baseIngredients).forEach(ing => {
                            const key = ing.toLowerCase().replace(/[^a-z]/g, '');
                            ingredientCount.set(key, (ingredientCount.get(key) || 0) + 1);
                        });
                    }
                });
                
                // Finde Tage mit seltenen Zutaten
                plan.forEach((day, index) => {
                    if (!day.dinner || day.dinner.special === 'pizza-weekend') return;
                    
                    let rareIngredients = 0;
                    if (day.dinner.baseIngredients) {
                        Object.keys(day.dinner.baseIngredients).forEach(ing => {
                            const key = ing.toLowerCase().replace(/[^a-z]/g, '');
                            if ((ingredientCount.get(key) || 0) === 1) {
                                rareIngredients++;
                            }
                        });
                    }
                    
                    // Wenn mehr als 3 seltene Zutaten, ersetze
                    if (rareIngredients > 3) {
                        const isVeg = day.dinner.category === 'Vegetarisch';
                        const availableRecipes = isVeg ? 
                            recipes.vegetarian : recipes.meat;
                        
                        // Suche Rezept mit h√§ufigen Zutaten
                        const filtered = SmartPlanner.filterRecipes(availableRecipes)
                            .filter(r => {
                                if (!r.baseIngredients) return false;
                                let commonCount = 0;
                                Object.keys(r.baseIngredients).forEach(ing => {
                                    const key = ing.toLowerCase().replace(/[^a-z]/g, '');
                                    if ((ingredientCount.get(key) || 0) > 1) {
                                        commonCount++;
                                    }
                                });
                                return commonCount >= 2;
                            });
                        
                        if (filtered.length > 0) {
                            newPlan[index].dinner = SmartPlanner.addVariations({...filtered[0]});
                            newPlan[index].variations = newPlan[index].dinner.variations;
                            improved = true;
                        }
                    }
                });
                
                return {
                    plan: newPlan,
                    improved: improved
                };
            },
            
            // Arbeitsfreundlichkeit optimieren
            optimizeForWork: function(plan, recipes) {
                let improved = false;
                let newPlan = [...plan];
                
                // Montag bis Donnerstag sollten aufw√§rmbar sein
                for (let i = 0; i <= 3; i++) {
                    const day = plan[i];
                    if (!day.dinner || day.dinner.special === 'pizza-weekend') continue;
                    
                    // Pr√ºfe ob aufw√§rmfreundlich
                    const tags = day.dinner.tags || [];
                    const name = day.dinner.name.toLowerCase();
                    
                    const isGoodForWork = 
                        day.dinner.workFriendly === true ||
                        tags.includes('auflauf') || 
                        tags.includes('eintopf') ||
                        tags.includes('curry') ||
                        name.includes('lasagne') ||
                        name.includes('bolognese');
                    
                    if (!isGoodForWork) {
                        const isVeg = day.dinner.category === 'Vegetarisch';
                        const availableRecipes = isVeg ? 
                            recipes.vegetarian : recipes.meat;
                        
                        const workFriendly = SmartPlanner.filterRecipes(availableRecipes)
                            .filter(r => r.workFriendly === true);
                        
                        if (workFriendly.length > 0) {
                            const randomIndex = Math.floor(Math.random() * workFriendly.length);
                            newPlan[i].dinner = SmartPlanner.addVariations({...workFriendly[randomIndex]});
                            newPlan[i].variations = newPlan[i].dinner.variations;
                            improved = true;
                        }
                    }
                }
                
                return {
                    plan: newPlan,
                    improved: improved
                };
            },
            
            // Abwechslung optimieren
            optimizeVariety: function(plan, recipes) {
                let improved = false;
                let newPlan = [...plan];
                
                // Pr√ºfe auf Wiederholungen
                for (let i = 0; i < plan.length - 1; i++) {
                    const current = plan[i].dinner;
                    const next = plan[i + 1].dinner;
                    
                    if (!current || !next || current.special === 'pizza-weekend') continue;
                    
                    // Pr√ºfe Hauptzutaten
                    const currentMain = this.getMainIngredient(current);
                    const nextMain = this.getMainIngredient(next);
                    
                    if (currentMain === nextMain && currentMain !== '') {
                        // Ersetze das zweite Gericht
                        const isVeg = next.category === 'Vegetarisch';
                        const availableRecipes = isVeg ? 
                            recipes.vegetarian : recipes.meat;
                        
                        const different = SmartPlanner.filterRecipes(availableRecipes)
                            .filter(r => this.getMainIngredient(r) !== currentMain);
                        
                        if (different.length > 0) {
                            const randomIndex = Math.floor(Math.random() * different.length);
                            newPlan[i + 1].dinner = SmartPlanner.addVariations({...different[randomIndex]});
                            newPlan[i + 1].variations = newPlan[i + 1].dinner.variations;
                            improved = true;
                        }
                    }
                }
                
                return {
                    plan: newPlan,
                    improved: improved
                };
            },
            
            // Vorbereitungszeit optimieren
            optimizePrepTime: function(plan, recipes) {
                let improved = false;
                let newPlan = [...plan];
                
                // Wochentage sollten schnelle Gerichte haben
                for (let i = 0; i <= 4; i++) {
                    const day = plan[i];
                    if (!day.dinner || day.dinner.special === 'pizza-weekend') continue;
                    
                    const prepTime = day.dinner.prepTime || 30;
                    
                    // Wenn l√§nger als 35 Minuten an Wochentagen
                    if (prepTime > 35) {
                        const isVeg = day.dinner.category === 'Vegetarisch';
                        const availableRecipes = isVeg ? 
                            recipes.vegetarian : recipes.meat;
                        
                        const quickRecipes = SmartPlanner.filterRecipes(availableRecipes)
                            .filter(r => (r.prepTime || 30) <= 30);
                        
                        if (quickRecipes.length > 0) {
                            const randomIndex = Math.floor(Math.random() * quickRecipes.length);
                            newPlan[i].dinner = SmartPlanner.addVariations({...quickRecipes[randomIndex]});
                            newPlan[i].variations = newPlan[i].dinner.variations;
                            improved = true;
                        }
                    }
                }
                
                return {
                    plan: newPlan,
                    improved: improved
                };
            },
            
            // Hilfsfunktion: Hauptzutat ermitteln
            getMainIngredient: function(recipe) {
                if (!recipe.baseIngredients) return '';
                
                const mainIngredients = ['pasta', 'reis', 'kartoffel', 'quinoa', 'couscous'];
                const ingredients = Object.keys(recipe.baseIngredients);
                
                for (let main of mainIngredients) {
                    for (let ing of ingredients) {
                        if (ing.toLowerCase().includes(main)) {
                            return main;
                        }
                    }
                }
                
                // Pr√ºfe auf Fleischsorten
                const meats = ['h√§hnchen', 'rind', 'schwein', 'lamm', 'pute'];
                for (let meat of meats) {
                    for (let ing of ingredients) {
                        if (ing.toLowerCase().includes(meat)) {
                            return meat;
                        }
                    }
                }
                
                return '';
            }
        };

        // Aktualisierte optimizeCurrentPlan Funktion
        async function optimizeCurrentPlan() {
            if (!AppData.weekPlan || AppData.weekPlan.length === 0) {
                showToast('Kein Plan zum Optimieren vorhanden', 'error');
                return;
            }
            
            showLoading('Optimiere Wochenplan...');
            
            // F√ºhre Optimierung durch
            const result = PlanOptimizer.optimize(
                AppData.weekPlan,
                AppData.recipes,
                AppData.preferences
            );
            
            if (result.optimized) {
                AppData.weekPlan = result.plan;
                
                // Zeige Verbesserungen
                let message = 'Optimiert: ' + result.improvements.join(', ');
                
                // Aktualisiere Anzeige
                displayWeekPlan();
                generateShoppingList();
                displayShoppingList();
                
                // Speichere
                await saveToCloud();
                
                hideLoading();
                showToast(message, 'success');
            } else {
                hideLoading();
                showToast('Plan ist bereits optimal! üëç', 'info');
            }
        }

        // Rest des Original-Codes (SmartPlanner, etc.)
        const SmartPlanner = {
            // Berechne Portionen f√ºr einen Tag
            calculatePortionsForDay: function(dayIndex) {
                let totalPortions = 0;
                
                // Basis-Portionen aller Personen
                AppData.preferences.persons.forEach(person => {
                    totalPortions += person.portions;
                });
                
                // Sonntag bis Donnerstag: +1 Portion f√ºr n√§chsten Tag (Arbeit)
                if (dayIndex >= 0 && dayIndex <= 3 || dayIndex === 6) {
                    totalPortions += 1;
                }
                
                return totalPortions;
            },

            // Pizza-Logik
            shouldHavePizzaWeekend: function() {
                const freq = AppData.preferences.pizzaFrequency;
                const weeksSince = AppData.preferences.weeksSincePizza;
                
                if (freq === "0") return false;
                
                if (freq === "3") {
                    if (weeksSince >= 3) return true;
                    if (weeksSince >= 2) return Math.random() > 0.5;
                } else {
                    return weeksSince >= parseInt(freq);
                }
                return false;
            },

            // Filter Rezepte basierend auf Pr√§ferenzen
            filterRecipes: function(recipes) {
                const filters = AppData.preferences.filters;
                return recipes.filter(recipe => {
                    const ingredients = JSON.stringify(recipe.baseIngredients).toLowerCase();
                    const name = recipe.name.toLowerCase();
                    
                    if (filters.noLamb && (name.includes('lamm') || ingredients.includes('lamm'))) return false;
                    if (filters.noPork && (name.includes('schwein') || ingredients.includes('schwein') || 
                        name.includes('speck') || ingredients.includes('speck'))) return false;
                    if (filters.noBeef && (name.includes('rind') || ingredients.includes('rind') || 
                        name.includes('kalb') || ingredients.includes('kalb'))) return false;
                    if (filters.noDuck && (name.includes('ente') || ingredients.includes('ente'))) return false;
                    if (filters.noGorgonzola && ingredients.includes('gorgonzola')) return false;
                    if (filters.noFeta && ingredients.includes('feta')) return false;
                    if (filters.noFish && (name.includes('fisch') || ingredients.includes('fisch'))) return false;
                    if (filters.noMushrooms && (ingredients.includes('pilz') || ingredients.includes('champignon'))) return false;
                    if (filters.noNuts && (ingredients.includes('nuss') || ingredients.includes('n√ºsse') || 
                        ingredients.includes('erdnuss'))) return false;
                    if (filters.noSpicy && (recipe.tags && recipe.tags.includes('scharf'))) return false;
                    
                    return true;
                });
            },

            // Erstelle intelligenten Wochenplan
            createPlan: function(recipes, preferences) {
                const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
                const plan = [];
                const usedRecipes = new Set();
                const usedMainIngredients = new Map();
                
                // Pr√ºfe Pizza-Wochenende
                const isPizzaWeekend = this.shouldHavePizzaWeekend();
                if (isPizzaWeekend) {
                    AppData.preferences.weeksSincePizza = 0;
                    document.getElementById('pizzaIndicator').style.display = 'block';
                } else {
                    AppData.preferences.weeksSincePizza++;
                    document.getElementById('pizzaIndicator').style.display = 'none';
                }
                
                // Gefilterte Rezepte
                const meatRecipes = this.filterRecipes(recipes.meat || []);
                const vegRecipes = this.filterRecipes(recipes.vegetarian || []);
                const kidsRecipes = recipes.kids || [];
                
                // W√§hle Kindergerichte f√ºr Dienstag und Donnerstag
                const kidsLunchTue = kidsRecipes[Math.floor(Math.random() * kidsRecipes.length)];
                const kidsLunchThu = kidsRecipes.filter(r => r.id !== kidsLunchTue.id)[
                    Math.floor(Math.random() * (kidsRecipes.length - 1))
                ];
                AppData.kidsLunchTueThu = { tuesday: kidsLunchTue, thursday: kidsLunchThu };
                
                // Verteile vegetarische Tage intelligent
                const vegDayIndices = this.distributeVegDays(7, preferences.vegDays);
                
                days.forEach((day, index) => {
                    let recipe = null;
                    let kidsLunch = null;
                    
                    // Pizza-Wochenende (Freitag und Samstag)
                    if (isPizzaWeekend && (index === 4 || index === 5)) {
                        recipe = this.createPizzaRecipe(index === 4 ? 'Freitag' : 'Samstag');
                    } else {
                        const isVegDay = vegDayIndices.includes(index);
                        const availableRecipes = isVegDay ? vegRecipes : meatRecipes;
                        
                        recipe = this.selectSmartRecipe(
                            availableRecipes,
                            usedRecipes,
                            usedMainIngredients,
                            index
                        );
                    }
                    
                    // F√ºge Variationen hinzu
                    if (recipe && recipe.baseIngredients) {
                        recipe = this.addVariations(recipe);
                    }
                    
                    // Kindergerichte f√ºr Dienstag und Donnerstag
                    if (index === 1) { // Dienstag
                        kidsLunch = kidsLunchTue;
                    } else if (index === 3) { // Donnerstag
                        kidsLunch = kidsLunchThu;
                    }
                    
                    plan.push({
                        day: day,
                        date: this.getDateForDay(index),
                        dinner: recipe,
                        kidsLunch: kidsLunch,
                        variations: recipe.variations || []
                    });
                    
                    if (recipe && recipe.id) {
                        usedRecipes.add(recipe.id);
                        this.trackIngredients(recipe, usedMainIngredients, index);
                    }
                });
                
                return plan;
            },

            // Pizza-Rezept erstellen
            createPizzaRecipe: function(dayName) {
                const isFriday = dayName === 'Freitag';
                return {
                    id: isFriday ? 'pizza-friday' : 'pizza-saturday',
                    name: isFriday ? 'Pizza-Freitag (Selbstgemacht)' : 'Pizza-Samstag (Tag 2)',
                    category: 'Pizza-Weekend',
                    baseIngredients: isFriday ? {
                        'Pizzamehl (f√ºr 2 Tage)': {amount: 300, unit: 'g'},
                        'San Marzano Tomaten': {amount: 100, unit: 'g'},
                        'Mozzarella': {amount: 125, unit: 'g', variations: ['B√ºffelmozzarella', 'Fior di Latte']},
                        'Belag nach Wahl': {amount: 75, unit: 'g'},
                        'Oliven√∂l': {amount: 1, unit: 'EL'},
                        'Hefe': {amount: 0.25, unit: 'W√ºrfel'}
                    } : {
                        'Teig vom Vortag': {amount: 0, unit: 'vorhanden'},
                        'Restliche Sauce': {amount: 0, unit: 'vorhanden'},
                        'Mozzarella': {amount: 125, unit: 'g'},
                        'Andere Bel√§ge': {amount: 75, unit: 'g'}
                    },
                    price: 4,
                    prepTime: 30,
                    tags: ['pizza', 'wochenende', 'familie'],
                    special: 'pizza-weekend'
                };
            },

            // Verteile vegetarische Tage
            distributeVegDays: function(totalDays, vegCount) {
                if (vegCount === 0) return [];
                if (vegCount >= totalDays) return Array.from({length: totalDays}, (_, i) => i);
                
                const positions = [];
                const spacing = Math.floor(totalDays / vegCount);
                
                for (let i = 0; i < vegCount; i++) {
                    let pos = i * spacing + Math.floor(Math.random() * Math.max(1, spacing - 1));
                    if (pos >= totalDays) pos = totalDays - 1;
                    if (!positions.includes(pos)) {
                        positions.push(pos);
                    }
                }
                
                return positions;
            },

            // W√§hle intelligentes Rezept
            selectSmartRecipe: function(availableRecipes, usedRecipes, usedMainIngredients, dayIndex) {
                const isWeekend = dayIndex >= 5;
                const needsWorkFriendly = dayIndex < 4;
                
                let candidates = availableRecipes.filter(recipe => {
                    if (usedRecipes.has(recipe.id)) return false;
                    if (needsWorkFriendly && recipe.workFriendly === false) return false;
                    
                    for (let [ingredient, lastDay] of usedMainIngredients) {
                        if (recipe.baseIngredients && recipe.baseIngredients[ingredient]) {
                            if (Math.abs(dayIndex - lastDay) < 2) {
                                return false;
                            }
                        }
                    }
                    
                    return true;
                });
                
                if (candidates.length === 0) {
                    candidates = availableRecipes.filter(r => !usedRecipes.has(r.id));
                }
                
                if (candidates.length > 0) {
                    const selected = candidates[Math.floor(Math.random() * candidates.length)];
                    return {...selected};
                }
                
                return availableRecipes[Math.floor(Math.random() * availableRecipes.length)];
            },

            // F√ºge Variationen hinzu
            addVariations: function(recipe) {
                const variations = [];
                
                if (recipe.baseIngredients) {
                    Object.entries(recipe.baseIngredients).forEach(([key, value]) => {
                        if (value.variations && value.variations.length > 0) {
                            variations.push({
                                type: key,
                                options: value.variations,
                                selected: value.variations[0]
                            });
                        }
                    });
                }
                
                recipe.variations = variations;
                return recipe;
            },

            // Tracke verwendete Zutaten
            trackIngredients: function(recipe, usedMainIngredients, dayIndex) {
                if (!recipe.baseIngredients) return;
                
                const mainIngredients = ['pasta', 'reis', 'kartoffel', 'fleisch', 'k√§se', 'sahne'];
                
                Object.keys(recipe.baseIngredients).forEach(ingredient => {
                    const lower = ingredient.toLowerCase();
                    mainIngredients.forEach(main => {
                        if (lower.includes(main)) {
                            usedMainIngredients.set(main, dayIndex);
                        }
                    });
                });
            },

            // Datum f√ºr Tag berechnen
            getDateForDay: function(dayIndex) {
                const today = new Date();
                const currentDay = today.getDay();
                const daysUntilMonday = currentDay === 0 ? 1 : 8 - currentDay;
                const monday = new Date(today);
                monday.setDate(today.getDate() + daysUntilMonday - 7);
                
                const targetDate = new Date(monday);
                targetDate.setDate(monday.getDate() + dayIndex);
                
                return targetDate.toLocaleDateString('de-CH', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });
            }
        };

        // ========== CLOUD SYNC FUNKTIONEN ==========
        
        // Suche nach existierenden Wochenplan-Gists
        async function findExistingGists() {
            try {
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${CloudSync.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Fehler beim Abrufen der Gists');
                }
                
                const gists = await response.json();
                
                // Suche nach Wochenplan-Gists
                const wochenplanGists = gists.filter(gist => {
                    return gist.description && gist.description.includes('Wochenplan');
                });
                
                if (wochenplanGists.length > 0) {
                    // Sortiere nach √Ñnderungsdatum (neuester zuerst)
                    wochenplanGists.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                    
                    console.log(`Found ${wochenplanGists.length} Wochenplan Gists, using newest one`);
                    return wochenplanGists[0].id;
                }
                
                return null;
            } catch (error) {
                console.error('Fehler bei der Gist-Suche:', error);
                return null;
            }
        }

        // Initialisierung
        window.addEventListener('DOMContentLoaded', async function() {
            const savedToken = localStorage.getItem('githubToken');
            
            if (savedToken) {
                CloudSync.token = savedToken;
                document.getElementById('settingsGithubToken').value = savedToken;
                await initializeApp();
            } else {
                showSetupModal();
            }
        });

        // Setup Modal anzeigen
        function showSetupModal() {
            document.getElementById('setupModal').classList.add('active');
        }

        // Mit Cloud verbinden
        async function connectToCloud() {
            const token = document.getElementById('githubToken').value;
            
            if (!token) {
                showToast('Bitte Token eingeben!', 'error');
                return;
            }
            
            showLoading('Suche Wochenpl√§ne...');
            
            CloudSync.token = token;
            localStorage.setItem('githubToken', token);
            
            try {
                // Suche nach existierenden Gists
                const existingGistId = await findExistingGists();
                
                if (existingGistId) {
                    CloudSync.gistId = existingGistId;
                    localStorage.setItem('currentGistId', existingGistId);
                    showToast('Plan gefunden!', 'success');
                } else {
                    // Erstelle neuen Gist
                    await createNewCloudPlan();
                    showToast('Neuer Plan erstellt!', 'success');
                }
                
                document.getElementById('setupModal').classList.remove('active');
                await initializeApp();
                
            } catch (error) {
                showToast('Fehler: ' + error.message, 'error');
                hideLoading();
            }
        }

        // App initialisieren
        async function initializeApp() {
            showLoading('Lade Rezepte...');
            
            try {
                await loadRecipes();
                
                // Versuche existierende Gists zu finden, falls noch keine ID vorhanden
                if (!CloudSync.gistId) {
                    const existingGistId = await findExistingGists();
                    if (existingGistId) {
                        CloudSync.gistId = existingGistId;
                        localStorage.setItem('currentGistId', existingGistId);
                    }
                }
                
                if (CloudSync.gistId) {
                    await loadFromCloud();
                    updateSyncInfo();
                } else {
                    await createNewCloudPlan();
                    await generateSmartPlan();
                }
                
                startAutoSync();
                startSyncPolling();
                updateCloudStatus('online');
                displayWeekPlan();
                updateStatistics();
                updatePizzaCountdown();
                displayPersonsList();
                hideLoading();
                
            } catch (error) {
                console.error('Initialisierungsfehler:', error);
                showToast('Fehler: ' + error.message, 'error');
                hideLoading();
            }
        }

        // Rezepte laden
        async function loadRecipes() {
            try {
                console.log('Lade Rezepte aus dem recipes Ordner...');
                
                // Paralleles Laden aller drei Dateien
                const [meatResponse, vegResponse, kidsResponse] = await Promise.all([
                    fetch('recipes/meat.json'),
                    fetch('recipes/vegetarian.json'),
                    fetch('recipes/kids.json')
                ]);

                // Parse die JSON Dateien
                const meatData = meatResponse.ok ? await meatResponse.json() : null;
                const vegData = vegResponse.ok ? await vegResponse.json() : null;
                const kidsData = kidsResponse.ok ? await kidsResponse.json() : null;

                // Extrahiere die recipes Arrays
                const meatRecipes = [];
                const vegRecipes = [];
                const kidsRecipes = [];

                // Meat recipes
                if (meatData && meatData.recipes) {
                    meatRecipes.push(...meatData.recipes);
                }

                // Vegetarian recipes
                if (vegData && vegData.recipes) {
                    vegRecipes.push(...vegData.recipes);
                }

                // Kids recipes
                if (kidsData && kidsData.recipes) {
                    kidsRecipes.push(...kidsData.recipes);
                }

                // Speichere in der vereinfachten Struktur
                AppData.recipes = {
                    meat: meatRecipes,
                    vegetarian: vegRecipes,
                    kids: kidsRecipes
                };

                console.log('Geladene Rezepte:', {
                    meat: meatRecipes.length,
                    vegetarian: vegRecipes.length,
                    kids: kidsRecipes.length
                });

                if (meatRecipes.length === 0 && vegRecipes.length === 0 && kidsRecipes.length === 0) {
                    throw new Error('Keine Rezepte gefunden!');
                }

                showToast(`${meatRecipes.length + vegRecipes.length + kidsRecipes.length} Rezepte geladen`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der Rezepte:', error);
                showToast('Fehler beim Laden: ' + error.message, 'error');
                
                // Fallback mit leeren Arrays
                AppData.recipes = {
                    meat: [],
                    vegetarian: [],
                    kids: []
                };
            }
        }

        // Statistiken aktualisieren
        function updateStatistics() {
            const total = countTotalRecipes();
            const meat = AppData.recipes && AppData.recipes.meat ? AppData.recipes.meat.length : 0;
            const veg = AppData.recipes && AppData.recipes.vegetarian ? AppData.recipes.vegetarian.length : 0;
            const kids = AppData.recipes && AppData.recipes.kids ? AppData.recipes.kids.length : 0;
            
            document.getElementById('totalRecipes').textContent = total;
            document.getElementById('meatCount').textContent = meat;
            document.getElementById('vegCount').textContent = veg;
            document.getElementById('kidsCount').textContent = kids;
        }

        // Z√§hle alle Rezepte
        function countTotalRecipes() {
            let count = 0;
            if (AppData.recipes) {
                count += (AppData.recipes.meat || []).length;
                count += (AppData.recipes.vegetarian || []).length;
                count += (AppData.recipes.kids || []).length;
            }
            return count;
        }

        // Pizza Countdown aktualisieren
        function updatePizzaCountdown() {
            const freq = AppData.preferences.pizzaFrequency;
            const weeksSince = AppData.preferences.weeksSincePizza;
            
            if (freq === "0") {
                document.getElementById('pizzaCountdown').textContent = 'deaktiviert';
            } else if (freq === "3") {
                const nextPizza = Math.max(1, 3 - weeksSince);
                document.getElementById('pizzaCountdown').textContent = nextPizza;
            } else {
                const nextPizza = Math.max(1, parseInt(freq) - weeksSince);
                document.getElementById('pizzaCountdown').textContent = nextPizza;
            }
        }

        // Neuen Cloud-Plan erstellen
        async function createNewCloudPlan() {
            const gistData = {
                description: `Wochenplan ${new Date().toLocaleDateString('de-CH')}`,
                public: false,
                files: {
                    'wochenplan.json': {
                        content: JSON.stringify({
                            version: '3.0',
                            weekPlan: [],
                            preferences: AppData.preferences,
                            shoppingList: {},
                            kidsLunchTueThu: null,
                            lastUpdate: new Date().toISOString()
                        }, null, 2)
                    }
                }
            };
            
            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${CloudSync.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gistData)
            });
            
            if (!response.ok) {
                throw new Error('Fehler beim Erstellen des Cloud-Plans');
            }
            
            const result = await response.json();
            CloudSync.gistId = result.id;
            localStorage.setItem('currentGistId', result.id);
            updateSyncInfo();
        }

        // Aus Cloud laden
        async function loadFromCloud() {
            if (!CloudSync.gistId) return;
            
            const response = await fetch(`https://api.github.com/gists/${CloudSync.gistId}`, {
                headers: {
                    'Authorization': `token ${CloudSync.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Fehler beim Laden aus der Cloud');
            }
            
            const gist = await response.json();
            const content = gist.files['wochenplan.json'].content;
            const data = JSON.parse(content);
            
            AppData.weekPlan = data.weekPlan || [];
            AppData.preferences = {...AppData.preferences, ...data.preferences};
            AppData.shoppingList = data.shoppingList || {};
            AppData.kidsLunchTueThu = data.kidsLunchTueThu || null;
            CloudSync.lastSync = new Date();
            CloudSync.lastUpdateTime = data.lastUpdate;
            
            loadPreferencesToUI();
            displayPersonsList();
            updateSyncInfo();
        }

        // In Cloud speichern
        async function saveToCloud() {
            if (!CloudSync.gistId) return;
            
            const data = {
                version: '3.0',
                weekPlan: AppData.weekPlan,
                preferences: AppData.preferences,
                shoppingList: AppData.shoppingList,
                kidsLunchTueThu: AppData.kidsLunchTueThu,
                lastUpdate: new Date().toISOString()
            };
            
            const response = await fetch(`https://api.github.com/gists/${CloudSync.gistId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${CloudSync.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'wochenplan.json': {
                            content: JSON.stringify(data, null, 2)
                        }
                    }
                })
            });
            
            if (response.ok) {
                CloudSync.lastSync = new Date();
                CloudSync.lastUpdateTime = data.lastUpdate;
                updateCloudStatus('online');
                updateSyncInfo();
            }
        }

        // Auto-Sync starten
        function startAutoSync() {
            CloudSync.syncInterval = setInterval(async () => {
                if (CloudSync.isOnline) {
                    await saveToCloud();
                }
            }, 10000); // 10 Sekunden
        }

        // Polling f√ºr √Ñnderungen
        function startSyncPolling() {
            CloudSync.syncPollInterval = setInterval(async () => {
                if (CloudSync.isOnline && CloudSync.gistId) {
                    try {
                        const response = await fetch(`https://api.github.com/gists/${CloudSync.gistId}`, {
                            headers: {
                                'Authorization': `token ${CloudSync.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (response.ok) {
                            const gist = await response.json();
                            const content = gist.files['wochenplan.json'].content;
                            const data = JSON.parse(content);
                            
                            // Pr√ºfe ob es neuere √Ñnderungen gibt
                            if (data.lastUpdate && CloudSync.lastUpdateTime && 
                                new Date(data.lastUpdate) > new Date(CloudSync.lastUpdateTime)) {
                                
                                console.log('Neuere Version gefunden, lade...');
                                AppData.weekPlan = data.weekPlan || [];
                                AppData.preferences = {...AppData.preferences, ...data.preferences};
                                AppData.shoppingList = data.shoppingList || {};
                                AppData.kidsLunchTueThu = data.kidsLunchTueThu || null;
                                CloudSync.lastUpdateTime = data.lastUpdate;
                                
                                displayWeekPlan();
                                loadPreferencesToUI();
                                displayPersonsList();
                                generateShoppingList();
                                displayShoppingList();
                                updateSyncInfo();
                                
                                showToast('√Ñnderungen empfangen', 'info');
                            }
                        }
                    } catch (error) {
                        console.error('Polling-Fehler:', error);
                    }
                }
            }, 5000); // Alle 5 Sekunden
        }

        // Auto-Save bei √Ñnderungen
        function triggerAutoSave() {
            clearTimeout(CloudSync.autoSaveTimeout);
            updateCloudStatus('syncing');
            CloudSync.autoSaveTimeout = setTimeout(async () => {
                await saveToCloud();
                showToast('Gespeichert', 'success');
            }, 500);
        }

        // Manueller Cloud Sync
        async function forceCloudSync() {
            showLoading('Synchronisiere...');
            try {
                await loadFromCloud();
                await saveToCloud();
                
                displayWeekPlan();
                displayShoppingList();
                showToast('Sync erfolgreich', 'success');
            } catch (error) {
                showToast('Sync fehlgeschlagen', 'error');
            }
            hideLoading();
        }

        // Update Token
        function updateToken() {
            const token = document.getElementById('settingsGithubToken').value;
            if (token) {
                CloudSync.token = token;
                localStorage.setItem('githubToken', token);
                showToast('Token aktualisiert', 'success');
                
                // Neuinitialisierung mit neuem Token
                initializeApp();
            }
        }

        // Sync Info aktualisieren
        function updateSyncInfo() {
            document.getElementById('syncStatus').textContent = CloudSync.isOnline ? 'Online' : 'Offline';
            document.getElementById('currentGistId').textContent = CloudSync.gistId ? 
                CloudSync.gistId.substring(0, 8) + '...' : '-';
            document.getElementById('lastSyncTime').textContent = CloudSync.lastSync ? 
                CloudSync.lastSync.toLocaleTimeString('de-CH', {hour: '2-digit', minute: '2-digit'}) : '-';
        }

        // Intelligenten Plan generieren
        async function generateSmartPlan() {
            if (!AppData.recipes) {
                await loadRecipes();
            }
            
            showLoading('Erstelle Plan...');
            
            if (AppData.recipes.kids && AppData.recipes.kids.length > 0) {
                console.log(`‚úÖ ${AppData.recipes.kids.length} Kindergerichte verf√ºgbar`);
            } else {
                console.warn('‚ö†Ô∏è KEINE Kindergerichte gefunden!');
                showToast('Warnung: Keine Kindergerichte!', 'error');
            }
            
            AppData.weekPlan = SmartPlanner.createPlan(AppData.recipes, AppData.preferences);
            
            generateShoppingList();
            
            await saveToCloud();
            
            displayWeekPlan();
            updatePizzaCountdown();
            hideLoading();
            
            showToast('Neuer Plan erstellt', 'success');
        }

        // Wochenplan anzeigen
        function displayWeekPlan() {
            const grid = document.getElementById('weekGrid');
            grid.innerHTML = '';
            let totalCost = 0;
            
            AppData.weekPlan.forEach((day, index) => {
                if (!day.dinner) return;
                
                const portions = SmartPlanner.calculatePortionsForDay(index);
                const dayCost = day.dinner.price * portions;
                totalCost += dayCost;
                
                let kidsLunchCost = 0;
                if (day.kidsLunch) {
                    const kidsPortions = AppData.preferences.persons
                        .filter(p => p.name.toLowerCase().includes('kind'))
                        .reduce((sum, p) => sum + p.portions, 0);
                    kidsLunchCost = day.kidsLunch.price * kidsPortions;
                    totalCost += kidsLunchCost;
                }
                
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                if (day.dinner.special === 'pizza-weekend') {
                    dayCard.className += ' pizza-day';
                }
                
                let variationsHtml = '';
                if (day.variations && day.variations.length > 0) {
                    variationsHtml = day.variations.map(v => `
                        <div class="meal-variations">
                            <small style="color: #666; font-size: 0.65em;">Variante:</small>
                            ${v.options.map(opt => `
                                <span class="variation-chip ${opt === v.selected ? 'active' : ''}" 
                                      onclick="selectVariation(${index}, '${v.type}', '${opt}')">
                                    ${opt}
                                </span>
                            `).join('')}
                        </div>
                    `).join('');
                }
                
                let kidsLunchHtml = '';
                if (day.kidsLunch) {
                    kidsLunchHtml = `
                        <div class="meal-section" style="background: #fff3e0;">
                            <div class="meal-type">üßí Kinder-Mittag</div>
                            <div class="meal-name">${day.kidsLunch.name}</div>
                            <div class="meal-details">
                                ${kidsLunchCost.toFixed(2)} CHF
                            </div>
                        </div>
                    `;
                }
                
                let portionInfo = `${portions.toFixed(1)} Port.`;
                if (index <= 3 || index === 6) {
                    portionInfo += ' (+1 Arbeit)';
                }
                
                dayCard.innerHTML = `
                    ${day.dinner.special !== 'pizza-weekend' ? 
                        `<button class="swap-btn" onclick="changeMeal(${index})">‚Üª</button>` : ''}
                    <div class="day-header">
                        <span class="day-name">${day.day}<small>${day.date}</small></span>
                        <span class="price-tag">${(dayCost + kidsLunchCost).toFixed(2)} CHF</span>
                    </div>
                    ${kidsLunchHtml}
                    <div class="meal-section">
                        <div class="meal-type">üçΩÔ∏è Abendessen</div>
                        <div class="meal-name">
                            ${day.dinner.name}
                        </div>
                        <div class="meal-details">
                            ${day.dinner.category || ''} ‚Ä¢ ${portionInfo}
                        </div>
                        ${variationsHtml}
                    </div>
                `;
                
                grid.appendChild(dayCard);
            });
            
            document.getElementById('totalCost').textContent = totalCost.toFixed(2);
        }

        // Variation ausw√§hlen
        function selectVariation(dayIndex, type, option) {
            const day = AppData.weekPlan[dayIndex];
            if (day.variations) {
                const variation = day.variations.find(v => v.type === type);
                if (variation) {
                    variation.selected = option;
                    displayWeekPlan();
                    generateShoppingList();
                    triggerAutoSave();
                }
            }
        }

        // Mahlzeit √§ndern
        function changeMeal(dayIndex) {
            const day = AppData.weekPlan[dayIndex];
            const isVeg = day.dinner.category === 'Vegetarisch';
            
            const availableRecipes = isVeg ? 
                AppData.recipes.vegetarian :
                AppData.recipes.meat;
            
            const filtered = SmartPlanner.filterRecipes(availableRecipes);
            const newRecipe = filtered[Math.floor(Math.random() * filtered.length)];
            
            AppData.weekPlan[dayIndex].dinner = SmartPlanner.addVariations({...newRecipe});
            AppData.weekPlan[dayIndex].variations = AppData.weekPlan[dayIndex].dinner.variations;
            
            displayWeekPlan();
            generateShoppingList();
            triggerAutoSave();
        }

        // Einkaufsliste generieren
        function generateShoppingList() {
            AppData.shoppingList = {};
            
            AppData.weekPlan.forEach((day, index) => {
                const portions = SmartPlanner.calculatePortionsForDay(index);
                
                if (day.dinner && day.dinner.baseIngredients) {
                    Object.entries(day.dinner.baseIngredients).forEach(([key, value]) => {
                        const ingredient = day.variations && day.variations.find(v => v.type === key)
                            ? day.variations.find(v => v.type === key).selected
                            : key;
                        
                        if (!AppData.shoppingList[ingredient]) {
                            AppData.shoppingList[ingredient] = {
                                amount: 0,
                                unit: value.unit || ''
                            };
                        }
                        
                        if (value.amount > 0) {
                            AppData.shoppingList[ingredient].amount += value.amount * portions;
                        }
                    });
                }
                
                if (day.kidsLunch && day.kidsLunch.baseIngredients) {
                    const kidsPortions = AppData.preferences.persons
                        .filter(p => p.name.toLowerCase().includes('kind'))
                        .reduce((sum, p) => sum + p.portions, 0);
                    
                    Object.entries(day.kidsLunch.baseIngredients).forEach(([key, value]) => {
                        if (!AppData.shoppingList[key]) {
                            AppData.shoppingList[key] = {
                                amount: 0,
                                unit: value.unit || ''
                            };
                        }
                        
                        if (value.amount > 0) {
                            AppData.shoppingList[key].amount += value.amount * kidsPortions;
                        }
                    });
                }
            });
        }

        // Tab wechseln
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'shopping') {
                displayShoppingList();
            } else if (tabName === 'recipes') {
                displayRecipes();
            }
        }

        // Einkaufsliste anzeigen
        function displayShoppingList() {
            const grid = document.getElementById('shoppingGrid');
            grid.innerHTML = '';
            
            const categories = {
                'Fleisch & Fisch': [],
                'Milchprodukte': [],
                'Gem√ºse & Obst': [],
                'Nudeln & Reis': [],
                'Sonstiges': []
            };
            
            Object.entries(AppData.shoppingList).forEach(([item, data]) => {
                const lower = item.toLowerCase();
                let category = 'Sonstiges';
                
                if (lower.includes('fleisch') || lower.includes('h√§hnchen') || lower.includes('rind') || 
                    lower.includes('schwein') || lower.includes('lamm') || lower.includes('fisch')) {
                    category = 'Fleisch & Fisch';
                } else if (lower.includes('k√§se') || lower.includes('milch') || lower.includes('sahne') || 
                           lower.includes('butter') || lower.includes('joghurt') || lower.includes('mozzarella')) {
                    category = 'Milchprodukte';
                } else if (lower.includes('zwiebel') || lower.includes('paprika') || lower.includes('zucchini') || 
                           lower.includes('tomate') || lower.includes('kartoffel') || lower.includes('salat')) {
                    category = 'Gem√ºse & Obst';
                } else if (lower.includes('pasta') || lower.includes('reis') || lower.includes('nudel') || 
                           lower.includes('sp√§tzle') || lower.includes('spaghetti') || lower.includes('penne')) {
                    category = 'Nudeln & Reis';
                }
                
                categories[category].push({
                    name: item,
                    amount: Math.round(data.amount * 10) / 10,
                    unit: data.unit
                });
            });
            
            Object.entries(categories).forEach(([category, items]) => {
                if (items.length === 0) return;
                
                const catDiv = document.createElement('div');
                catDiv.className = 'shopping-category';
                
                const icon = category === 'Fleisch & Fisch' ? 'ü•©' :
                            category === 'Milchprodukte' ? 'üßÄ' :
                            category === 'Gem√ºse & Obst' ? 'ü•ï' :
                            category === 'Nudeln & Reis' ? 'üçù' : 'üì¶';
                
                catDiv.innerHTML = `
                    <h3>${icon} ${category}</h3>
                    ${items.map(item => `
                        <div class="shopping-item">
                            <input type="checkbox">
                            <span>${item.name}: ${item.amount} ${item.unit}</span>
                        </div>
                    `).join('')}
                `;
                grid.appendChild(catDiv);
            });
        }

        // Rezepte anzeigen
        function displayRecipes() {
            const container = document.getElementById('recipesList');
            container.innerHTML = '';
            
            AppData.weekPlan.forEach((day, index) => {
                const portions = SmartPlanner.calculatePortionsForDay(index);
                
                if (day.dinner) {
                    const recipeDiv = document.createElement('div');
                    
                    recipeDiv.innerHTML = `
                        <h3>${day.day} - Abend: ${day.dinner.name}</h3>
                        <p style="color: #666; margin-bottom: 8px;">F√ºr ${portions} Portionen</p>
                        <div style="background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                            <h4>Zutaten:</h4>
                            <ul>
                                ${day.dinner.baseIngredients ? Object.entries(day.dinner.baseIngredients).map(([ing, data]) => 
                                    `<li>${ing}: ${(data.amount * portions).toFixed(1)} ${data.unit || ''}</li>`
                                ).join('') : ''}
                            </ul>
                        </div>
                    `;
                    
                    container.appendChild(recipeDiv);
                }
                
                if (day.kidsLunch) {
                    const kidsPortions = AppData.preferences.persons
                        .filter(p => p.name.toLowerCase().includes('kind'))
                        .reduce((sum, p) => sum + p.portions, 0);
                    
                    const kidsDiv = document.createElement('div');
                    kidsDiv.style.cssText = 'background: #fff3e0;';
                    
                    kidsDiv.innerHTML = `
                        <h3>${day.day} - Mittag: ${day.kidsLunch.name}</h3>
                        <p style="color: #666; margin-bottom: 8px;">F√ºr ${kidsPortions} Kinder</p>
                        <div style="background: white; padding: 10px; border-radius: 6px;">
                            <h4>Zutaten:</h4>
                            <ul>
                                ${day.kidsLunch.baseIngredients ? Object.entries(day.kidsLunch.baseIngredients).map(([ing, data]) => 
                                    `<li>${ing}: ${(data.amount * kidsPortions).toFixed(1)} ${data.unit || ''}</li>`
                                ).join('') : ''}
                            </ul>
                        </div>
                    `;
                    
                    container.appendChild(kidsDiv);
                }
            });
        }

        // Personenliste anzeigen
        function displayPersonsList() {
            const container = document.getElementById('personsList');
            container.innerHTML = '';
            
            AppData.preferences.persons.forEach((person, index) => {
                const personDiv = document.createElement('div');
                personDiv.className = 'person-item';
                
                personDiv.innerHTML = `
                    <input type="text" value="${person.name}" onchange="updatePersonName(${index}, this.value)">
                    <input type="number" value="${person.portions}" min="0.1" max="3" step="0.1" 
                           onchange="updatePersonPortions(${index}, this.value)">
                    <button class="remove-btn" onclick="removePerson(${index})">Entfernen</button>
                `;
                
                container.appendChild(personDiv);
            });
        }

        // Person hinzuf√ºgen
        function addPerson() {
            const newPerson = {
                name: `Person ${AppData.preferences.persons.length + 1}`,
                portions: 1.0
            };
            AppData.preferences.persons.push(newPerson);
            displayPersonsList();
            triggerAutoSave();
        }

        // Person entfernen
        function removePerson(index) {
            if (AppData.preferences.persons.length > 1) {
                AppData.preferences.persons.splice(index, 1);
                displayPersonsList();
                displayWeekPlan();
                generateShoppingList();
                triggerAutoSave();
            } else {
                showToast('Mind. 1 Person n√∂tig', 'error');
            }
        }

        // Person Name aktualisieren
        function updatePersonName(index, name) {
            AppData.preferences.persons[index].name = name;
            triggerAutoSave();
        }

        // Person Portionen aktualisieren
        function updatePersonPortions(index, portions) {
            AppData.preferences.persons[index].portions = parseFloat(portions);
            displayWeekPlan();
            generateShoppingList();
            triggerAutoSave();
        }

        // Einstellungen aktualisieren
        function updatePreferences() {
            AppData.preferences.vegDays = parseInt(document.getElementById('vegDays').value);
            AppData.preferences.dailyBudget = parseInt(document.getElementById('dailyBudget').value);
            AppData.preferences.pizzaFrequency = document.getElementById('pizzaFrequency').value;
            
            AppData.preferences.filters.noLamb = document.getElementById('noLamb').checked;
            AppData.preferences.filters.noPork = document.getElementById('noPork').checked;
            AppData.preferences.filters.noBeef = document.getElementById('noBeef').checked;
            AppData.preferences.filters.noDuck = document.getElementById('noDuck').checked;
            AppData.preferences.filters.noGorgonzola = document.getElementById('noGorgonzola').checked;
            AppData.preferences.filters.noFeta = document.getElementById('noFeta').checked;
            AppData.preferences.filters.noFish = document.getElementById('noFish').checked;
            AppData.preferences.filters.noMushrooms = document.getElementById('noMushrooms').checked;
            AppData.preferences.filters.noNuts = document.getElementById('noNuts').checked;
            AppData.preferences.filters.noSpicy = document.getElementById('noSpicy').checked;
            
            const weeklyBudget = AppData.preferences.dailyBudget * 7;
            document.getElementById('weeklyBudget').textContent = `${weeklyBudget} CHF`;
            
            triggerAutoSave();
        }

        // Pr√§ferenzen in UI laden
        function loadPreferencesToUI() {
            document.getElementById('vegDays').value = AppData.preferences.vegDays;
            document.getElementById('dailyBudget').value = AppData.preferences.dailyBudget;
            document.getElementById('pizzaFrequency').value = AppData.preferences.pizzaFrequency;
            
            if (AppData.preferences.filters) {
                document.getElementById('noLamb').checked = AppData.preferences.filters.noLamb || false;
                document.getElementById('noPork').checked = AppData.preferences.filters.noPork || false;
                document.getElementById('noBeef').checked = AppData.preferences.filters.noBeef || false;
                document.getElementById('noDuck').checked = AppData.preferences.filters.noDuck || false;
                document.getElementById('noGorgonzola').checked = AppData.preferences.filters.noGorgonzola || false;
                document.getElementById('noFeta').checked = AppData.preferences.filters.noFeta || false;
                document.getElementById('noFish').checked = AppData.preferences.filters.noFish || false;
                document.getElementById('noMushrooms').checked = AppData.preferences.filters.noMushrooms || false;
                document.getElementById('noNuts').checked = AppData.preferences.filters.noNuts || false;
                document.getElementById('noSpicy').checked = AppData.preferences.filters.noSpicy || false;
            }
            
            const weeklyBudget = AppData.preferences.dailyBudget * 7;
            document.getElementById('weeklyBudget').textContent = `${weeklyBudget} CHF`;
        }

        // PDF Export
        function exportToPDF() {
            window.print();
        }

        // Cloud Status Update
        function updateCloudStatus(status) {
            const statusEl = document.getElementById('cloudStatus');
            const statusText = document.getElementById('cloudStatusText');
            
            statusEl.className = 'cloud-status';
            
            switch(status) {
                case 'online':
                    statusText.textContent = 'Synchronisiert';
                    break;
                case 'syncing':
                    statusEl.classList.add('syncing');
                    statusText.textContent = 'Sync...';
                    break;
                case 'offline':
                    statusEl.classList.add('offline');
                    statusText.textContent = 'Offline';
                    break;
            }
        }

        // UI Helper Functions
        function showLoading(message) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.querySelector('p').textContent = message || 'Lade...';
            overlay.classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Online/Offline Detection
        window.addEventListener('online', () => {
            CloudSync.isOnline = true;
            updateCloudStatus('online');
            saveToCloud();
        });

        window.addEventListener('offline', () => {
            CloudSync.isOnline = false;
            updateCloudStatus('offline');
        });

        // Cleanup beim Verlassen
        window.addEventListener('beforeunload', () => {
            if (CloudSync.syncInterval) {
                clearInterval(CloudSync.syncInterval);
            }
            if (CloudSync.syncPollInterval) {
                clearInterval(CloudSync.syncPollInterval);
            }
        });
    </script>
</body>
</html>
