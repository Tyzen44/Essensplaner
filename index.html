<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familien-Wochenplaner | Cloud Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header mit Cloud-Status */
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            position: relative;
        }

        .header h1 {
            color: #764ba2;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .cloud-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #e8f5e9;
            border-radius: 20px;
            font-size: 14px;
            color: #2e7d32;
        }

        .cloud-status.offline {
            background: #ffebee;
            color: #c62828;
        }

        .cloud-status.syncing {
            background: #fff3e0;
            color: #f57c00;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Pizza-Wochenende Anzeige */
        .pizza-indicator {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 15px;
            display: inline-block;
            animation: pizzaPulse 2s infinite;
        }

        @keyframes pizzaPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #f8f8f8;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 16px;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e8e8e8;
        }

        /* Tab-Inhalte */
        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Hauptsteuerung */
        .main-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(118,75,162,0.3);
        }

        .btn-secondary {
            background: white;
            color: #764ba2;
            border: 2px solid #764ba2;
        }

        .btn-secondary:hover {
            background: #f8f8f8;
        }

        /* Wochen√ºbersicht */
        .day-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .day-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #764ba2;
            transition: all 0.3s;
            position: relative;
        }

        .day-card.pizza-day {
            background: linear-gradient(135deg, #fff5f5 0%, #ffeaa7 100%);
            border-left: 5px solid #ff6b6b;
        }

        .day-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .day-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #764ba2;
        }

        .price-tag {
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        .meal-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .meal-details {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .meal-variations {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .variation-chip {
            padding: 3px 8px;
            background: #e3f2fd;
            border-radius: 12px;
            font-size: 12px;
            color: #1976d2;
            cursor: pointer;
            transition: all 0.2s;
        }

        .variation-chip:hover {
            background: #1976d2;
            color: white;
        }

        .variation-chip.active {
            background: #764ba2;
            color: white;
        }

        .swap-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .swap-btn:hover {
            background: #764ba2;
            transform: rotate(180deg);
        }

        /* Einkaufsliste */
        .shopping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .shopping-category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .shopping-category h3 {
            color: #764ba2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
        }

        .shopping-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .shopping-item:last-child {
            border-bottom: none;
        }

        .shopping-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        /* Einstellungen */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .setting-group {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
        }

        .setting-group h3 {
            color: #764ba2;
            margin-bottom: 15px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 10px;
            color: #666;
        }

        .setting-group input[type="number"],
        .setting-group select,
        .setting-group input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 5px;
        }

        .setting-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            margin: 0;
        }

        /* Statistiken */
        .stats-box {
            background: #e8f4f8;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-box h3 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #764ba2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Setup Modal */
        .setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .setup-modal.active {
            display: flex;
        }

        .setup-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .setup-content h2 {
            color: #764ba2;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #764ba2;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 20px;
            background: #323232;
            color: white;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s;
            z-index: 10000;
        }

        .toast.show {
            display: block;
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #f44336;
        }

        .toast.info {
            background: #2196F3;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Budget-Anzeige */
        .budget-display {
            font-size: 1.2em;
            color: #4CAF50;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            background: #f0fff4;
            border-radius: 10px;
            margin: 20px 0;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .cloud-status {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 15px;
            }
            
            .main-controls {
                grid-template-columns: 1fr;
            }
            
            .shopping-grid {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Synchronisiere mit Cloud...</p>
    </div>

    <!-- Setup Modal -->
    <div class="setup-modal" id="setupModal">
        <div class="setup-content">
            <h2>Cloud-Verbindung einrichten</h2>
            <div class="form-group">
                <label>GitHub Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                <small style="color: #666; display: block; margin-top: 5px;">
                    Token erstellen: GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens
                </small>
            </div>
            <div class="form-group">
                <label>Gist ID (optional - f√ºr bestehenden Plan):</label>
                <input type="text" id="existingGistId" placeholder="Leer lassen f√ºr neuen Plan">
            </div>
            <div class="form-group">
                <label>Anzahl Erwachsene:</label>
                <input type="number" id="adultsCount" value="2" min="1" max="6">
            </div>
            <div class="form-group">
                <label>Anzahl Kinder:</label>
                <input type="number" id="childrenCount" value="2" min="0" max="6">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="connectToCloud()">
                Mit Cloud verbinden
            </button>
        </div>
    </div>

    <!-- Cloud Status Indicator -->
    <div class="cloud-status" id="cloudStatus">
        <div class="pulse"></div>
        <span id="cloudStatusText">Verbinde...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Familien-Wochenplaner</h1>
            <p>Intelligente Essensplanung mit Cloud-Synchronisation</p>
            <p style="margin-top: 10px; color: #666;">
                <span id="weekDate">Woche wird geladen...</span>
            </p>
            <div id="pizzaIndicator" style="display: none;">
                <span class="pizza-indicator">Pizza-Wochenende!</span>
            </div>
        </div>

        <!-- Statistiken -->
        <div class="stats-box">
            <h3>Rezept-Datenbank</h3>
            <p><strong id="totalRecipes">0</strong> Rezepte verf√ºgbar | 
               <strong id="meatCount">0</strong> Fleisch | 
               <strong id="vegCount">0</strong> Vegetarisch | 
               <strong id="kidsCount">0</strong> Kinder</p>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                N√§chstes Pizza-Wochenende in <strong id="pizzaCountdown">...</strong> Woche(n)
            </p>
        </div>

        <!-- Hauptsteuerung -->
        <div class="main-controls">
            <button class="btn btn-primary" onclick="generateSmartPlan()">
                Neuen Plan generieren
            </button>
            <button class="btn btn-secondary" onclick="optimizeCurrentPlan()">
                Plan optimieren
            </button>
            <button class="btn btn-secondary" onclick="exportToPDF()">
                Als PDF exportieren
            </button>
            <button class="btn btn-secondary" onclick="forceCloudSync()">
                Cloud synchronisieren
            </button>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'overview')">Wochen√ºbersicht</button>
            <button class="tab" onclick="switchTab(event, 'shopping')">Einkaufsliste</button>
            <button class="tab" onclick="switchTab(event, 'recipes')">Rezepte</button>
            <button class="tab" onclick="switchTab(event, 'settings')">Einstellungen</button>
        </div>

        <!-- Tab: Wochen√ºbersicht -->
        <div id="overview" class="tab-content active">
            <div class="day-grid" id="weekGrid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
            <div class="budget-display">
                Gesamtkosten der Woche: <span id="totalCost">0</span> CHF
            </div>
        </div>

        <!-- Tab: Einkaufsliste -->
        <div id="shopping" class="tab-content">
            <h2>Einkaufsliste</h2>
            <div class="shopping-grid" id="shoppingGrid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>

        <!-- Tab: Rezepte -->
        <div id="recipes" class="tab-content">
            <h2>Detaillierte Rezepte</h2>
            <div id="recipesList">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>

        <!-- Tab: Einstellungen -->
        <div id="settings" class="tab-content">
            <h2>Einstellungen</h2>
            <div class="settings-grid">
                <div class="setting-group">
                    <h3>Familie</h3>
                    <label>
                        Anzahl Erwachsene:
                        <input type="number" id="settingsAdults" value="2" min="1" max="6" onchange="updatePreferences()">
                    </label>
                    <label>
                        Anzahl Kinder:
                        <input type="number" id="settingsChildren" value="2" min="0" max="6" onchange="updatePreferences()">
                    </label>
                </div>
                
                <div class="setting-group">
                    <h3>Budget</h3>
                    <label>
                        Tagesbudget (CHF):
                        <input type="number" id="dailyBudget" value="25" min="10" max="50" onchange="updatePreferences()">
                    </label>
                    <label>
                        Wochenbudget: <strong id="weeklyBudget">175 CHF</strong>
                    </label>
                </div>
                
                <div class="setting-group">
                    <h3>Ern√§hrung</h3>
                    <label>
                        Vegetarische Tage pro Woche:
                        <input type="number" id="vegDays" value="3" min="0" max="7" onchange="updatePreferences()">
                    </label>
                    <label>
                        Pizza-Wochenende alle:
                        <select id="pizzaFrequency" onchange="updatePreferences()">
                            <option value="2">2 Wochen</option>
                            <option value="3" selected>2-3 Wochen (Zufall)</option>
                            <option value="4">3-4 Wochen</option>
                            <option value="0">Nie</option>
                        </select>
                    </label>
                </div>

                <div class="setting-group">
                    <h3>Ausschl√ºsse - Fleisch</h3>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="noLamb" onchange="updatePreferences()"> Kein Lamm
                        </label>
                        <label>
                            <input type="checkbox" id="noPork" onchange="updatePreferences()"> Kein Schwein
                        </label>
                        <label>
                            <input type="checkbox" id="noBeef" onchange="updatePreferences()"> Kein Rind
                        </label>
                        <label>
                            <input type="checkbox" id="noDuck" onchange="updatePreferences()"> Keine Ente
                        </label>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>Ausschl√ºsse - Milchprodukte</h3>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="noGorgonzola" onchange="updatePreferences()"> Kein Gorgonzola
                        </label>
                        <label>
                            <input type="checkbox" id="noFeta" onchange="updatePreferences()"> Kein Feta
                        </label>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>Weitere Ausschl√ºsse</h3>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="noFish" onchange="updatePreferences()"> Kein Fisch
                        </label>
                        <label>
                            <input type="checkbox" id="noMushrooms" onchange="updatePreferences()"> Keine Pilze
                        </label>
                        <label>
                            <input type="checkbox" id="noNuts" onchange="updatePreferences()"> Keine N√ºsse
                        </label>
                        <label>
                            <input type="checkbox" id="noSpicy" onchange="updatePreferences()"> Nicht scharf
                        </label>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>GitHub Token</h3>
                    <label>
                        Personal Access Token:
                        <input type="password" id="settingsGithubToken" placeholder="ghp_xxxxxxxxxxxx" onchange="updatePreferences()">
                    </label>
                    <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
                        F√ºr Cloud-Synchronisation
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Globale Cloud-Sync Konfiguration
        const CloudSync = {
            token: null,
            gistId: null,
            syncInterval: null,
            lastSync: null,
            isOnline: true,
            autoSaveTimeout: null
        };

        // Globale App-Daten
        let AppData = {
            weekPlan: [],
            recipes: null,
            preferences: {
                adults: 2,
                children: 2,
                weeksSincePizza: 0,
                vegDays: 3,
                dailyBudget: 25,
                pizzaFrequency: "3",
                filters: {
                    noLamb: false,
                    noPork: false,
                    noBeef: false,
                    noDuck: false,
                    noGorgonzola: false,
                    noFeta: false,
                    noFish: false,
                    noMushrooms: false,
                    noNuts: false,
                    noSpicy: false
                }
            },
            currentWeekStart: null,
            shoppingList: {}
        };

        // Intelligente Planungs-Engine
        const SmartPlanner = {
            // Pizza-Logik
            shouldHavePizzaWeekend: function() {
                const freq = AppData.preferences.pizzaFrequency;
                const weeksSince = AppData.preferences.weeksSincePizza;
                
                if (freq === "0") return false;
                
                if (freq === "3") {
                    // 2-3 Wochen mit Zufall
                    if (weeksSince >= 3) return true;
                    if (weeksSince >= 2) return Math.random() > 0.5;
                } else {
                    // Feste Frequenz
                    return weeksSince >= parseInt(freq);
                }
                return false;
            },

            // Filter Rezepte basierend auf Pr√§ferenzen
            filterRecipes: function(recipes, category) {
                const filters = AppData.preferences.filters;
                return recipes.filter(recipe => {
                    // Pr√ºfe alle Zutaten
                    const ingredients = JSON.stringify(recipe.baseIngredients).toLowerCase();
                    const name = recipe.name.toLowerCase();
                    
                    if (filters.noLamb && (name.includes('lamm') || ingredients.includes('lamm'))) return false;
                    if (filters.noPork && (name.includes('schwein') || ingredients.includes('schwein') || 
                        name.includes('speck') || ingredients.includes('speck'))) return false;
                    if (filters.noBeef && (name.includes('rind') || ingredients.includes('rind') || 
                        name.includes('kalb') || ingredients.includes('kalb'))) return false;
                    if (filters.noDuck && (name.includes('ente') || ingredients.includes('ente'))) return false;
                    if (filters.noGorgonzola && ingredients.includes('gorgonzola')) return false;
                    if (filters.noFeta && ingredients.includes('feta')) return false;
                    if (filters.noFish && (name.includes('fisch') || ingredients.includes('fisch'))) return false;
                    if (filters.noMushrooms && (ingredients.includes('pilz') || ingredients.includes('champignon'))) return false;
                    if (filters.noNuts && (ingredients.includes('nuss') || ingredients.includes('n√ºsse') || 
                        ingredients.includes('erdnuss'))) return false;
                    if (filters.noSpicy && (recipe.tags && recipe.tags.includes('scharf'))) return false;
                    
                    return true;
                });
            },

            // Erstelle intelligenten Wochenplan
            createPlan: function(recipes, preferences) {
                const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
                const plan = [];
                const usedRecipes = new Set();
                const usedMainIngredients = new Map();
                
                // Pr√ºfe Pizza-Wochenende
                const isPizzaWeekend = this.shouldHavePizzaWeekend();
                if (isPizzaWeekend) {
                    AppData.preferences.weeksSincePizza = 0;
                    document.getElementById('pizzaIndicator').style.display = 'block';
                } else {
                    AppData.preferences.weeksSincePizza++;
                    document.getElementById('pizzaIndicator').style.display = 'none';
                }
                
                // Gefilterte Rezepte
                const meatRecipes = this.filterRecipes(recipes.categories.meat.recipes);
                const vegRecipes = this.filterRecipes(recipes.categories.vegetarian.recipes);
                
                // Verteile vegetarische Tage intelligent
                const vegDayIndices = this.distributeVegDays(7, preferences.vegDays);
                
                days.forEach((day, index) => {
                    let recipe = null;
                    
                    // Pizza-Wochenende (Freitag und Samstag)
                    if (isPizzaWeekend && (index === 4 || index === 5)) {
                        recipe = this.createPizzaRecipe(index === 4 ? 'Freitag' : 'Samstag');
                    } else {
                        // W√§hle zwischen Fleisch und Vegetarisch
                        const isVegDay = vegDayIndices.includes(index);
                        const availableRecipes = isVegDay ? vegRecipes : meatRecipes;
                        
                        recipe = this.selectSmartRecipe(
                            availableRecipes,
                            usedRecipes,
                            usedMainIngredients,
                            index
                        );
                    }
                    
                    // F√ºge Variationen hinzu
                    if (recipe && recipe.baseIngredients) {
                        recipe = this.addVariations(recipe);
                    }
                    
                    plan.push({
                        day: day,
                        date: this.getDateForDay(index),
                        dinner: recipe,
                        variations: recipe.variations || []
                    });
                    
                    if (recipe && recipe.id) {
                        usedRecipes.add(recipe.id);
                        this.trackIngredients(recipe, usedMainIngredients, index);
                    }
                });
                
                return plan;
            },

            // Pizza-Rezept erstellen
            createPizzaRecipe: function(dayName) {
                const isFriday = dayName === 'Freitag';
                return {
                    id: isFriday ? 'pizza-friday' : 'pizza-saturday',
                    name: isFriday ? 'Pizza-Freitag (Selbstgemacht)' : 'Pizza-Samstag (Tag 2)',
                    category: 'Pizza-Weekend',
                    baseIngredients: isFriday ? {
                        'Pizzamehl (f√ºr 2 Tage)': {amount: 300, unit: 'g'},
                        'San Marzano Tomaten': {amount: 100, unit: 'g'},
                        'Mozzarella': {amount: 125, unit: 'g', variations: ['B√ºffelmozzarella', 'Fior di Latte']},
                        'Belag nach Wahl': {amount: 75, unit: 'g'},
                        'Oliven√∂l': {amount: 1, unit: 'EL'},
                        'Hefe': {amount: 0.25, unit: 'W√ºrfel'}
                    } : {
                        'Teig vom Vortag': {amount: 0, unit: 'vorhanden'},
                        'Restliche Sauce': {amount: 0, unit: 'vorhanden'},
                        'Mozzarella': {amount: 125, unit: 'g'},
                        'Andere Bel√§ge': {amount: 75, unit: 'g'}
                    },
                    price: 4,
                    tags: ['pizza', 'wochenende', 'familie'],
                    special: 'pizza-weekend'
                };
            },

            // Verteile vegetarische Tage
            distributeVegDays: function(totalDays, vegCount) {
                if (vegCount === 0) return [];
                if (vegCount >= totalDays) return Array.from({length: totalDays}, (_, i) => i);
                
                const positions = [];
                const spacing = Math.floor(totalDays / vegCount);
                
                for (let i = 0; i < vegCount; i++) {
                    let pos = i * spacing + Math.floor(Math.random() * Math.max(1, spacing - 1));
                    if (pos >= totalDays) pos = totalDays - 1;
                    if (!positions.includes(pos)) {
                        positions.push(pos);
                    }
                }
                
                return positions;
            },

            // W√§hle intelligentes Rezept
            selectSmartRecipe: function(availableRecipes, usedRecipes, usedMainIngredients, dayIndex) {
                const isWeekend = dayIndex >= 5;
                const needsWorkFriendly = dayIndex < 4;
                
                // Filtere nach verschiedenen Kriterien
                let candidates = availableRecipes.filter(recipe => {
                    // Nicht bereits verwendet
                    if (usedRecipes.has(recipe.id)) return false;
                    
                    // Arbeitstauglichkeit pr√ºfen
                    if (needsWorkFriendly && recipe.workFriendly === false) return false;
                    
                    // Pr√ºfe Wiederholungen von Hauptzutaten (5 Tage Abstand)
                    for (let [ingredient, lastDay] of usedMainIngredients) {
                        if (recipe.baseIngredients && recipe.baseIngredients[ingredient]) {
                            if (Math.abs(dayIndex - lastDay) < 5) {
                                return false;
                            }
                        }
                    }
                    
                    return true;
                });
                
                // Fallback wenn keine Kandidaten
                if (candidates.length === 0) {
                    candidates = availableRecipes.filter(r => !usedRecipes.has(r.id));
                }
                
                // W√§hle zuf√§llig
                if (candidates.length > 0) {
                    const selected = candidates[Math.floor(Math.random() * candidates.length)];
                    return {...selected}; // Kopie erstellen
                }
                
                // Letzter Fallback
                return availableRecipes[Math.floor(Math.random() * availableRecipes.length)];
            },

            // F√ºge Variationen hinzu
            addVariations: function(recipe) {
                const variations = [];
                
                if (recipe.baseIngredients) {
                    Object.entries(recipe.baseIngredients).forEach(([key, value]) => {
                        if (value.variations && value.variations.length > 0) {
                            variations.push({
                                type: key,
                                options: value.variations,
                                selected: value.variations[0]
                            });
                        }
                    });
                }
                
                recipe.variations = variations;
                return recipe;
            },

            // Tracke verwendete Zutaten
            trackIngredients: function(recipe, usedMainIngredients, dayIndex) {
                if (!recipe.baseIngredients) return;
                
                // Hauptzutaten tracken
                const mainIngredients = ['pasta', 'reis', 'kartoffel', 'fleisch', 'k√§se', 'sahne'];
                
                Object.keys(recipe.baseIngredients).forEach(ingredient => {
                    const lower = ingredient.toLowerCase();
                    mainIngredients.forEach(main => {
                        if (lower.includes(main)) {
                            usedMainIngredients.set(main, dayIndex);
                        }
                    });
                });
            },

            // Datum f√ºr Tag berechnen
            getDateForDay: function(dayIndex) {
                const today = new Date();
                const currentDay = today.getDay();
                const daysUntilMonday = currentDay === 0 ? 1 : 8 - currentDay;
                const monday = new Date(today);
                monday.setDate(today.getDate() + daysUntilMonday - 7);
                
                const targetDate = new Date(monday);
                targetDate.setDate(monday.getDate() + dayIndex);
                
                return targetDate.toLocaleDateString('de-CH', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });
            }
        };

        // Initialisierung
        window.addEventListener('DOMContentLoaded', async function() {
            const savedToken = sessionStorage.getItem('githubToken');
            const savedGistId = sessionStorage.getItem('currentGistId');
            
            if (savedToken && savedGistId) {
                CloudSync.token = savedToken;
                CloudSync.gistId = savedGistId;
                await initializeApp();
            } else {
                showSetupModal();
            }
        });

        // Setup Modal anzeigen
        function showSetupModal() {
            document.getElementById('setupModal').classList.add('active');
        }

        // Mit Cloud verbinden
        async function connectToCloud() {
            const token = document.getElementById('githubToken').value;
            const gistId = document.getElementById('existingGistId').value;
            const adults = document.getElementById('adultsCount').value;
            const children = document.getElementById('childrenCount').value;
            
            if (!token) {
                showToast('Bitte GitHub Token eingeben!', 'error');
                return;
            }
            
            showLoading('Verbinde mit Cloud...');
            
            CloudSync.token = token;
            sessionStorage.setItem('githubToken', token);
            
            AppData.preferences.adults = parseInt(adults);
            AppData.preferences.children = parseInt(children);
            
            try {
                if (gistId) {
                    CloudSync.gistId = gistId;
                    sessionStorage.setItem('currentGistId', gistId);
                    await loadFromCloud();
                } else {
                    await createNewCloudPlan();
                }
                
                document.getElementById('setupModal').classList.remove('active');
                await initializeApp();
                
            } catch (error) {
                showToast('Fehler: ' + error.message, 'error');
                hideLoading();
            }
        }

        // App initialisieren
        async function initializeApp() {
            showLoading('Lade Rezepte und synchronisiere...');
            
            try {
                await loadRecipes();
                
                if (CloudSync.gistId) {
                    await loadFromCloud();
                } else {
                    await generateSmartPlan();
                }
                
                startAutoSync();
                updateCloudStatus('online');
                displayWeekPlan();
                updateStatistics();
                updatePizzaCountdown();
                hideLoading();
                
            } catch (error) {
                console.error('Initialisierungsfehler:', error);
                showToast('Fehler beim Laden: ' + error.message, 'error');
                hideLoading();
            }
        }

        // Rezepte laden
        async function loadRecipes() {
            try {
                const response = await fetch('recipes.json');
                if (!response.ok) {
                    throw new Error('Fehler beim Laden der Rezepte');
                }
                AppData.recipes = await response.json();
                console.log(`${countTotalRecipes()} Rezepte geladen`);
            } catch (error) {
                console.error('Fehler beim Laden der recipes.json:', error);
                showToast('Fehler beim Laden der Rezepte!', 'error');
                AppData.recipes = {
                    categories: {
                        meat: { recipes: [] },
                        vegetarian: { recipes: [] },
                        kids: { recipes: [] }
                    }
                };
            }
        }

        // Z√§hle alle Rezepte
        function countTotalRecipes() {
            let count = 0;
            Object.values(AppData.recipes.categories).forEach(cat => {
                count += cat.recipes.length;
            });
            return count;
        }

        // Statistiken aktualisieren
        function updateStatistics() {
            const total = countTotalRecipes();
            const meat = AppData.recipes.categories.meat ? AppData.recipes.categories.meat.recipes.length : 0;
            const veg = AppData.recipes.categories.vegetarian ? AppData.recipes.categories.vegetarian.recipes.length : 0;
            const kids = AppData.recipes.categories.kids ? AppData.recipes.categories.kids.recipes.length : 0;
            
            document.getElementById('totalRecipes').textContent = total;
            document.getElementById('meatCount').textContent = meat;
            document.getElementById('vegCount').textContent = veg;
            document.getElementById('kidsCount').textContent = kids;
        }

        // Pizza Countdown aktualisieren
        function updatePizzaCountdown() {
            const freq = AppData.preferences.pizzaFrequency;
            const weeksSince = AppData.preferences.weeksSincePizza;
            
            if (freq === "0") {
                document.getElementById('pizzaCountdown').textContent = 'deaktiviert';
            } else if (freq === "3") {
                const nextPizza = Math.max(1, 3 - weeksSince);
                document.getElementById('pizzaCountdown').textContent = nextPizza;
            } else {
                const nextPizza = Math.max(1, parseInt(freq) - weeksSince);
                document.getElementById('pizzaCountdown').textContent = nextPizza;
            }
        }

        // Neuen Cloud-Plan erstellen
        async function createNewCloudPlan() {
            const gistData = {
                description: `Wochenplan ${new Date().toLocaleDateString('de-CH')}`,
                public: false,
                files: {
                    'wochenplan.json': {
                        content: JSON.stringify({
                            version: '2.0',
                            weekPlan: [],
                            preferences: AppData.preferences,
                            shoppingList: {},
                            lastUpdate: new Date().toISOString()
                        }, null, 2)
                    }
                }
            };
            
            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${CloudSync.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gistData)
            });
            
            if (!response.ok) {
                throw new Error('Fehler beim Erstellen des Cloud-Plans');
            }
            
            const result = await response.json();
            CloudSync.gistId = result.id;
            localStorage.setItem('currentGistId', result.id);
        }

        // Aus Cloud laden
        async function loadFromCloud() {
            if (!CloudSync.gistId) return;
            
            const response = await fetch(`https://api.github.com/gists/${CloudSync.gistId}`, {
                headers: {
                    'Authorization': `token ${CloudSync.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Fehler beim Laden aus der Cloud');
            }
            
            const gist = await response.json();
            const content = gist.files['wochenplan.json'].content;
            const data = JSON.parse(content);
            
            AppData.weekPlan = data.weekPlan || [];
            AppData.preferences = {...AppData.preferences, ...data.preferences};
            AppData.shoppingList = data.shoppingList || {};
            CloudSync.lastSync = new Date();
            
            // Update UI mit geladenen Einstellungen
            loadPreferencesToUI();
        }

        // In Cloud speichern
        async function saveToCloud() {
            if (!CloudSync.gistId) return;
            
            const data = {
                version: '2.0',
                weekPlan: AppData.weekPlan,
                preferences: AppData.preferences,
                shoppingList: AppData.shoppingList,
                lastUpdate: new Date().toISOString()
            };
            
            const response = await fetch(`https://api.github.com/gists/${CloudSync.gistId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${CloudSync.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'wochenplan.json': {
                            content: JSON.stringify(data, null, 2)
                        }
                    }
                })
            });
            
            if (response.ok) {
                CloudSync.lastSync = new Date();
                updateCloudStatus('online');
            }
        }

        // Auto-Sync starten
        function startAutoSync() {
            CloudSync.syncInterval = setInterval(async () => {
                if (CloudSync.isOnline) {
                    await saveToCloud();
                }
            }, 30000); // Alle 30 Sekunden
        }

        // Auto-Save bei √Ñnderungen
        function triggerAutoSave() {
            clearTimeout(CloudSync.autoSaveTimeout);
            updateCloudStatus('syncing');
            CloudSync.autoSaveTimeout = setTimeout(async () => {
                await saveToCloud();
                showToast('Gespeichert', 'success');
            }, 2000);
        }

        // Manueller Cloud Sync
        async function forceCloudSync() {
            showLoading('Synchronisiere mit Cloud...');
            try {
                await saveToCloud();
                showToast('Synchronisation erfolgreich', 'success');
            } catch (error) {
                showToast('Synchronisation fehlgeschlagen', 'error');
            }
            hideLoading();
        }

        // Intelligenten Plan generieren
        async function generateSmartPlan() {
            if (!AppData.recipes) {
                await loadRecipes();
            }
            
            showLoading('Erstelle intelligenten Wochenplan...');
            
            AppData.weekPlan = SmartPlanner.createPlan(AppData.recipes, AppData.preferences);
            generateShoppingList();
            
            await saveToCloud();
            
            displayWeekPlan();
            updatePizzaCountdown();
            hideLoading();
            
            showToast('Neuer Plan erstellt', 'success');
        }

        // Plan optimieren
        async function optimizeCurrentPlan() {
            showLoading('Optimiere Plan...');
            
            // Hier k√∂nnte echte Optimierung stattfinden
            // z.B. Preisoptimierung, bessere Verteilung, etc.
            
            setTimeout(() => {
                hideLoading();
                showToast('Plan optimiert', 'success');
                triggerAutoSave();
            }, 1000);
        }

        // Wochenplan anzeigen
        function displayWeekPlan() {
            const grid = document.getElementById('weekGrid');
            grid.innerHTML = '';
            let totalCost = 0;
            
            AppData.weekPlan.forEach((day, index) => {
                if (!day.dinner) return;
                
                const portions = AppData.preferences.adults + (AppData.preferences.children * 0.5);
                const dayCost = day.dinner.price * portions;
                totalCost += dayCost;
                
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                if (day.dinner.special === 'pizza-weekend') {
                    dayCard.className += ' pizza-day';
                }
                
                let variationsHtml = '';
                if (day.variations && day.variations.length > 0) {
                    variationsHtml = day.variations.map(v => `
                        <div class="meal-variations">
                            <small style="color: #666;">Variante:</small>
                            ${v.options.map(opt => `
                                <span class="variation-chip ${opt === v.selected ? 'active' : ''}" 
                                      onclick="selectVariation(${index}, '${v.type}', '${opt}')">
                                    ${opt}
                                </span>
                            `).join('')}
                        </div>
                    `).join('');
                }
                
                dayCard.innerHTML = `
                    ${day.dinner.special !== 'pizza-weekend' ? 
                        `<button class="swap-btn" onclick="changeMeal(${index})">‚Üª</button>` : ''}
                    <div class="day-header">
                        <span class="day-name">${day.day} <small style="color: #999;">${day.date}</small></span>
                        <span class="price-tag">${dayCost.toFixed(2)} CHF</span>
                    </div>
                    <div class="meal-name">
                        ${day.dinner.name}
                    </div>
                    <div class="meal-details">
                        ${day.dinner.category || ''} ‚Ä¢ ${portions} Portionen
                    </div>
                    ${variationsHtml}
                `;
                
                grid.appendChild(dayCard);
            });
            
            document.getElementById('totalCost').textContent = totalCost.toFixed(2);
            
            // Update Wochendatum
            const weekStart = new Date();
            const weekEnd = new Date();
            weekEnd.setDate(weekStart.getDate() + 6);
            
            document.getElementById('weekDate').textContent = 
                `${weekStart.toLocaleDateString('de-CH')} - ${weekEnd.toLocaleDateString('de-CH')}`;
        }

        // Variation ausw√§hlen
        function selectVariation(dayIndex, type, option) {
            const day = AppData.weekPlan[dayIndex];
            if (day.variations) {
                const variation = day.variations.find(v => v.type === type);
                if (variation) {
                    variation.selected = option;
                    displayWeekPlan();
                    generateShoppingList();
                    triggerAutoSave();
                }
            }
        }

        // Mahlzeit √§ndern
        function changeMeal(dayIndex) {
            const day = AppData.weekPlan[dayIndex];
            const isVeg = day.dinner.category === 'Vegetarisch';
            
            const availableRecipes = isVeg ? 
                AppData.recipes.categories.vegetarian.recipes :
                AppData.recipes.categories.meat.recipes;
            
            const filtered = SmartPlanner.filterRecipes(availableRecipes);
            const newRecipe = filtered[Math.floor(Math.random() * filtered.length)];
            
            AppData.weekPlan[dayIndex].dinner = SmartPlanner.addVariations({...newRecipe});
            AppData.weekPlan[dayIndex].variations = AppData.weekPlan[dayIndex].dinner.variations;
            
            displayWeekPlan();
            generateShoppingList();
            triggerAutoSave();
        }

        // Einkaufsliste generieren
        function generateShoppingList() {
            AppData.shoppingList = {};
            const portions = AppData.preferences.adults + (AppData.preferences.children * 0.5);
            
            AppData.weekPlan.forEach(day => {
                if (day.dinner && day.dinner.baseIngredients) {
                    Object.entries(day.dinner.baseIngredients).forEach(([key, value]) => {
                        const ingredient = day.variations && day.variations.find(v => v.type === key)
                            ? day.variations.find(v => v.type === key).selected
                            : key;
                        
                        if (!AppData.shoppingList[ingredient]) {
                            AppData.shoppingList[ingredient] = {
                                amount: 0,
                                unit: value.unit || ''
                            };
                        }
                        
                        if (value.amount > 0) {
                            AppData.shoppingList[ingredient].amount += value.amount * portions;
                        }
                    });
                }
            });
        }

        // Tab wechseln
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'shopping') {
                displayShoppingList();
            } else if (tabName === 'recipes') {
                displayRecipes();
            }
        }

        // Einkaufsliste anzeigen
        function displayShoppingList() {
            const grid = document.getElementById('shoppingGrid');
            grid.innerHTML = '';
            
            const categories = {
                'Fleisch & Fisch': [],
                'Milchprodukte': [],
                'Gem√ºse & Obst': [],
                'Nudeln & Reis': [],
                'Sonstiges': []
            };
            
            Object.entries(AppData.shoppingList).forEach(([item, data]) => {
                const lower = item.toLowerCase();
                let category = 'Sonstiges';
                
                if (lower.includes('fleisch') || lower.includes('h√§hnchen') || lower.includes('rind') || 
                    lower.includes('schwein') || lower.includes('lamm') || lower.includes('fisch')) {
                    category = 'Fleisch & Fisch';
                } else if (lower.includes('k√§se') || lower.includes('milch') || lower.includes('sahne') || 
                           lower.includes('butter') || lower.includes('joghurt') || lower.includes('mozzarella')) {
                    category = 'Milchprodukte';
                } else if (lower.includes('zwiebel') || lower.includes('paprika') || lower.includes('zucchini') || 
                           lower.includes('tomate') || lower.includes('kartoffel') || lower.includes('salat')) {
                    category = 'Gem√ºse & Obst';
                } else if (lower.includes('pasta') || lower.includes('reis') || lower.includes('nudel') || 
                           lower.includes('sp√§tzle') || lower.includes('spaghetti') || lower.includes('penne')) {
                    category = 'Nudeln & Reis';
                }
                
                categories[category].push({
                    name: item,
                    amount: Math.round(data.amount * 10) / 10,
                    unit: data.unit
                });
            });
            
            Object.entries(categories).forEach(([category, items]) => {
                if (items.length === 0) return;
                
                const catDiv = document.createElement('div');
                catDiv.className = 'shopping-category';
                
                const icon = category === 'Fleisch & Fisch' ? 'ü•©' :
                            category === 'Milchprodukte' ? 'üßÄ' :
                            category === 'Gem√ºse & Obst' ? 'ü•ï' :
                            category === 'Nudeln & Reis' ? 'üçù' : 'üì¶';
                
                catDiv.innerHTML = `
                    <h3>${icon} ${category}</h3>
                    ${items.map(item => `
                        <div class="shopping-item">
                            <input type="checkbox">
                            <span>${item.name}: ${item.amount} ${item.unit}</span>
                        </div>
                    `).join('')}
                `;
                grid.appendChild(catDiv);
            });
        }

        // Rezepte anzeigen
        function displayRecipes() {
            const container = document.getElementById('recipesList');
            container.innerHTML = '';
            
            AppData.weekPlan.forEach(day => {
                if (!day.dinner) return;
                
                const recipeDiv = document.createElement('div');
                recipeDiv.style.cssText = 'background: #f9f9f9; border-radius: 10px; padding: 20px; margin-bottom: 20px;';
                
                const portions = AppData.preferences.adults + (AppData.preferences.children * 0.5);
                
                recipeDiv.innerHTML = `
                    <h3 style="color: #764ba2; margin-bottom: 15px;">
                        ${day.day} - ${day.dinner.name}
                    </h3>
                    <p style="color: #666; margin-bottom: 10px;">F√ºr ${portions} Portionen</p>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4>Zutaten:</h4>
                        <ul>
                            ${day.dinner.baseIngredients ? Object.entries(day.dinner.baseIngredients).map(([ing, data]) => 
                                `<li>${ing}: ${data.amount * portions} ${data.unit || ''}</li>`
                            ).join('') : ''}
                        </ul>
                    </div>
                    ${day.dinner.instructions ? `
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <h4>Zubereitung:</h4>
                            <ol>
                                ${day.dinner.instructions.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(recipeDiv);
            });
        }

        // Einstellungen aktualisieren
        function updatePreferences() {
            AppData.preferences.adults = parseInt(document.getElementById('settingsAdults').value);
            AppData.preferences.children = parseInt(document.getElementById('settingsChildren').value);
            AppData.preferences.vegDays = parseInt(document.getElementById('vegDays').value);
            AppData.preferences.dailyBudget = parseInt(document.getElementById('dailyBudget').value);
            AppData.preferences.pizzaFrequency = document.getElementById('pizzaFrequency').value;
            
            // Filter
            AppData.preferences.filters.noLamb = document.getElementById('noLamb').checked;
            AppData.preferences.filters.noPork = document.getElementById('noPork').checked;
            AppData.preferences.filters.noBeef = document.getElementById('noBeef').checked;
            AppData.preferences.filters.noDuck = document.getElementById('noDuck').checked;
            AppData.preferences.filters.noGorgonzola = document.getElementById('noGorgonzola').checked;
            AppData.preferences.filters.noFeta = document.getElementById('noFeta').checked;
            AppData.preferences.filters.noFish = document.getElementById('noFish').checked;
            AppData.preferences.filters.noMushrooms = document.getElementById('noMushrooms').checked;
            AppData.preferences.filters.noNuts = document.getElementById('noNuts').checked;
            AppData.preferences.filters.noSpicy = document.getElementById('noSpicy').checked;
            
            // Token
            const token = document.getElementById('settingsGithubToken').value;
            if (token) {
                CloudSync.token = token;
                sessionStorage.setItem('githubToken', token);
            }
            
            // Update Budget-Anzeige
            const weeklyBudget = AppData.preferences.dailyBudget * 7;
            document.getElementById('weeklyBudget').textContent = `${weeklyBudget} CHF`;
            
            triggerAutoSave();
        }

        // Pr√§ferenzen in UI laden
        function loadPreferencesToUI() {
            document.getElementById('settingsAdults').value = AppData.preferences.adults;
            document.getElementById('settingsChildren').value = AppData.preferences.children;
            document.getElementById('vegDays').value = AppData.preferences.vegDays;
            document.getElementById('dailyBudget').value = AppData.preferences.dailyBudget;
            document.getElementById('pizzaFrequency').value = AppData.preferences.pizzaFrequency;
            
            // Filter
            if (AppData.preferences.filters) {
                document.getElementById('noLamb').checked = AppData.preferences.filters.noLamb || false;
                document.getElementById('noPork').checked = AppData.preferences.filters.noPork || false;
                document.getElementById('noBeef').checked = AppData.preferences.filters.noBeef || false;
                document.getElementById('noDuck').checked = AppData.preferences.filters.noDuck || false;
                document.getElementById('noGorgonzola').checked = AppData.preferences.filters.noGorgonzola || false;
                document.getElementById('noFeta').checked = AppData.preferences.filters.noFeta || false;
                document.getElementById('noFish').checked = AppData.preferences.filters.noFish || false;
                document.getElementById('noMushrooms').checked = AppData.preferences.filters.noMushrooms || false;
                document.getElementById('noNuts').checked = AppData.preferences.filters.noNuts || false;
                document.getElementById('noSpicy').checked = AppData.preferences.filters.noSpicy || false;
            }
            
            const weeklyBudget = AppData.preferences.dailyBudget * 7;
            document.getElementById('weeklyBudget').textContent = `${weeklyBudget} CHF`;
        }

        // PDF Export
        function exportToPDF() {
            window.print();
        }

        // Cloud Status Update
        function updateCloudStatus(status) {
            const statusEl = document.getElementById('cloudStatus');
            const statusText = document.getElementById('cloudStatusText');
            
            statusEl.className = 'cloud-status';
            
            switch(status) {
                case 'online':
                    statusText.textContent = 'Synchronisiert';
                    break;
                case 'syncing':
                    statusEl.classList.add('syncing');
                    statusText.textContent = 'Synchronisiere...';
                    break;
                case 'offline':
                    statusEl.classList.add('offline');
                    statusText.textContent = 'Offline';
                    break;
            }
        }

        // UI Helper Functions
        function showLoading(message) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.querySelector('p').textContent = message || 'Lade...';
            overlay.classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Online/Offline Detection
        window.addEventListener('online', () => {
            CloudSync.isOnline = true;
            updateCloudStatus('online');
            saveToCloud();
        });

        window.addEventListener('offline', () => {
            CloudSync.isOnline = false;
            updateCloudStatus('offline');
        });

        // Cleanup beim Verlassen
        window.addEventListener('beforeunload', () => {
            if (CloudSync.syncInterval) {
                clearInterval(CloudSync.syncInterval);
            }
        });
    </script>
</body>
</html>
